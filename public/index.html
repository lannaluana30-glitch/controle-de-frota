<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeavyMaint Pro - Sistema de Gestão de Manutenção</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .sidebar-gradient {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .status-badge {
            @apply px-3 py-1 rounded-full text-xs font-semibold;
        }
        .status-aberta { @apply bg-yellow-100 text-yellow-800; }
        .status-andamento { @apply bg-blue-100 text-blue-800; }
        .status-finalizada { @apply bg-green-100 text-green-800; }
        .horimetro-alert { @apply bg-red-50 border-l-4 border-red-500; }
        .horimetro-warning { @apply bg-orange-50 border-l-4 border-orange-500; }
        .horimetro-ok { @apply bg-green-50 border-l-4 border-green-500; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .nav-item.active {
            background-color: #1e293b;
            border-left-color: #3b82f6;
        }
        
        .section-hidden {
            display: none !important;
        }

        .os-action-btn {
            position: relative;
            z-index: 10;
            cursor: pointer;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        
        /* Security Level Indicators */
        .security-high { @apply bg-green-100 text-green-800 border-green-200; }
        .security-medium { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
        .security-low { @apply bg-red-100 text-red-800 border-red-200; }
        
        /* Login Screen */
        .login-bg {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e3a8a 100%);
        }
        
        /* Permission Tree */
        .permission-item {
            @apply flex items-center justify-between p-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors;
        }
        
        /* Chart placeholders */
        .chart-container {
            @apply bg-white p-4 rounded-xl border border-slate-200;
        }

        /* Modal animations */
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        @keyframes modalEnter {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Timeline */
        .timeline-item {
            @apply relative pl-8 pb-8 border-l-2 border-slate-200 last:border-0;
        }
        .timeline-item::before {
            content: '';
            @apply absolute left-[-9px] top-0 w-4 h-4 rounded-full bg-blue-500 border-4 border-white shadow;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="login-bg min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
            <div class="bg-slate-900 p-8 text-center">
                <div class="w-20 h-20 bg-blue-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/50">
                    <i data-lucide="wrench" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">HeavyMaint Pro</h1>
                <p class="text-slate-400">Sistema de Gestão de Manutenção</p>
            </div>
            
            <div class="p-8">
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                        <div class="relative">
                            <i data-lucide="mail" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                            <input type="email" id="login-email" class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="seu@email.com" required>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Senha</label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                            <input type="password" id="login-password" class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="••••••" required>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mb-6">
                        <label class="flex items-center">
                            <input type="checkbox" class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm text-slate-600">Lembrar-me</span>
                        </label>
                        <a href="#" class="text-sm text-blue-600 hover:text-blue-700">Esqueceu a senha?</a>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="log-in" class="w-5 h-5"></i>
                        Entrar no Sistema
                    </button>
                </form>
                
                <div class="mt-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <p class="text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">Credenciais de Demonstração</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center p-2 bg-white rounded border border-slate-200 cursor-pointer hover:border-blue-300 transition-colors" onclick="fillLogin('admin@heavymaint.com', '123456')">
                            <span class="font-medium text-slate-700">Super Admin</span>
                            <span class="text-xs text-slate-500">admin@heavymaint.com</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-white rounded border border-slate-200 cursor-pointer hover:border-blue-300 transition-colors" onclick="fillLogin('gerente@heavymaint.com', '123456')">
                            <span class="font-medium text-slate-700">Gerente</span>
                            <span class="text-xs text-slate-500">gerente@heavymaint.com</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-white rounded border border-slate-200 cursor-pointer hover:border-blue-300 transition-colors" onclick="fillLogin('tecnico@heavymaint.com', '123456')">
                            <span class="font-medium text-slate-700">Técnico</span>
                            <span class="text-xs text-slate-500">tecnico@heavymaint.com</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="main-app" class="flex h-screen overflow-hidden section-hidden">
        
        <!-- Sidebar -->
        <aside class="w-64 sidebar-gradient text-white flex flex-col shadow-2xl z-20">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i data-lucide="wrench" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg tracking-tight">HeavyMaint</h1>
                        <p class="text-xs text-slate-400">Pro Edition</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto py-4" id="sidebar-nav">
                <!-- Menu items will be dynamically rendered based on permissions -->
            </nav>

            <div class="p-4 border-t border-slate-700">
                <div class="flex items-center gap-3">
                    <img id="user-avatar" src="" class="w-10 h-10 rounded-full">
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-sm font-medium truncate"></p>
                        <p id="user-role" class="text-xs text-slate-400"></p>
                    </div>
                    <button onclick="logout()" class="text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-slate-50">
            
            <!-- Top Bar -->
            <header class="glass-effect sticky top-0 z-10 border-b border-slate-200 px-8 py-4 flex justify-between items-center">
                <div>
                    <h2 id="page-title" class="text-2xl font-bold text-slate-800">Dashboard</h2>
                    <p id="page-subtitle" class="text-sm text-slate-500">Visão geral do sistema</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleWhatsAppModal()" class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors shadow-lg shadow-green-500/30">
                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                        <span class="hidden md:inline">WhatsApp Business</span>
                    </button>
                    <button class="relative p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                        <i data-lucide="bell" class="w-6 h-6"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                    </button>
                </div>
            </header>

            <div class="p-8" id="content-area">
                <!-- Content will be dynamically loaded here -->
            </div>
        </main>
    </div>

    <!-- MODAIS COMPLETOS -->

    <!-- Modal de OS (Criar/Editar/Visualizar) -->
    <div id="os-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto modal-enter">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-xl font-bold text-slate-800" id="os-modal-title">Nova Ordem de Serviço</h3>
                    <p class="text-sm text-slate-500" id="os-modal-subtitle">Preencha os dados da manutenção</p>
                </div>
                <button onclick="closeModal('os-modal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="os-form" onsubmit="saveOS(event)" class="p-6 space-y-6">
                <input type="hidden" id="os-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Título da OS <span class="text-red-500">*</span></label>
                            <input type="text" id="os-titulo" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Troca de óleo do motor" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Equipamento <span class="text-red-500">*</span></label>
                            <select id="os-equipamento" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                <option value="">Selecione o equipamento...</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Tipo de Manutenção</label>
                                <select id="os-tipo" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="Preventiva">Preventiva</option>
                                    <option value="Corretiva">Corretiva</option>
                                    <option value="Preditiva">Preditiva</option>
                                    <option value="Emergencial">Emergencial</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Prioridade</label>
                                <select id="os-prioridade" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="baixa">Baixa</option>
                                    <option value="media" selected>Média</option>
                                    <option value="alta">Alta</option>
                                    <option value="critica">Crítica</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Responsável</label>
                            <select id="os-responsavel" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">Selecione o técnico...</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Data de Abertura</label>
                                <input type="date" id="os-data" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Previsão de Conclusão</label>
                                <input type="date" id="os-previsao" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                            <select id="os-status" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="aberta">Aberta</option>
                                <option value="andamento">Em Andamento</option>
                                <option value="finalizada">Finalizada</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Descrição do Problema/Serviço</label>
                    <textarea id="os-descricao" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Descreva detalhadamente o problema ou serviço a ser realizado..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Peças/Materiais Utilizados</label>
                    <div class="border border-slate-300 rounded-lg p-4 space-y-2" id="os-pecas-list">
                        <div class="flex gap-2">
                            <select class="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">Selecione uma peça...</option>
                            </select>
                            <input type="number" placeholder="Qtd" class="w-20 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <button type="button" onclick="addOSPecaRow()" class="px-3 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('os-modal')" class="px-6 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Salvar OS
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Visualização de OS -->
    <div id="os-view-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto modal-enter">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-800" id="os-view-id">OS-2024-001</h3>
                        <p class="text-sm text-slate-500" id="os-view-status">Status: Em Andamento</p>
                    </div>
                </div>
                <button onclick="closeModal('os-view-modal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-100 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-slate-800 mb-3">Informações Gerais</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b border-slate-100">
                                <span class="text-slate-500">Equipamento:</span>
                                <span class="font-medium text-slate-800" id="os-view-equipamento">Escavadeira CAT 320D</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-slate-100">
                                <span class="text-slate-500">Tipo:</span>
                                <span class="font-medium text-slate-800" id="os-view-tipo">Preventiva</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-slate-100">
                                <span class="text-slate-500">Prioridade:</span>
                                <span class="font-medium" id="os-view-prioridade">Alta</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-slate-100">
                                <span class="text-slate-500">Responsável:</span>
                                <span class="font-medium text-slate-800" id="os-view-responsavel">Técnico Silva</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-slate-800 mb-3">Datas</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b border-slate-100">
                                <span class="text-slate-500">Abertura:</span>
                                <span class="font-medium text-slate-800" id="os-view-data">15/01/2024</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-slate-100">
                                <span class="text-slate-500">Previsão:</span>
                                <span class="font-medium text-slate-800" id="os-view-previsao">20/01/2024</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-slate-100">
                                <span class="text-slate-500">Conclusão:</span>
                                <span class="font-medium text-slate-800" id="os-view-conclusao">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold text-slate-800 mb-3">Descrição</h4>
                    <div class="bg-slate-50 p-4 rounded-lg text-sm text-slate-700" id="os-view-descricao">
                        Troca de óleo do motor e filtros conforme programa de manutenção preventiva.
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold text-slate-800 mb-3">Peças Utilizadas</h4>
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="text-left px-4 py-2 font-medium text-slate-600">Peça</th>
                                <th class="text-center px-4 py-2 font-medium text-slate-600">Qtd</th>
                                <th class="text-right px-4 py-2 font-medium text-slate-600">Valor Unit.</th>
                                <th class="text-right px-4 py-2 font-medium text-slate-600">Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="os-view-pecas">
                            <tr>
                                <td class="px-4 py-2">Óleo Lubrificante 15W40</td>
                                <td class="px-4 py-2 text-center">20L</td>
                                <td class="px-4 py-2 text-right">R$ 45,00</td>
                                <td class="px-4 py-2 text-right font-medium">R$ 900,00</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-2">Filtro de Óleo</td>
                                <td class="px-4 py-2 text-center">1</td>
                                <td class="px-4 py-2 text-right">R$ 120,00</td>
                                <td class="px-4 py-2 text-right font-medium">R$ 120,00</td>
                            </tr>
                        </tbody>
                        <tfoot class="bg-slate-50 font-semibold">
                            <tr>
                                <td colspan="3" class="px-4 py-2 text-right">Total:</td>
                                <td class="px-4 py-2 text-right text-blue-600">R$ 1.020,00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button onclick="printOS()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="printer" class="w-4 h-4"></i>
                        Imprimir
                    </button>
                    <button onclick="closeModal('os-view-modal')" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Equipamento -->
    <div id="equip-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-enter">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-slate-800" id="equip-modal-title">Novo Equipamento</h3>
                <button onclick="closeModal('equip-modal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="equip-form" onsubmit="saveEquip(event)" class="p-6 space-y-6">
                <input type="hidden" id="equip-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Código <span class="text-red-500">*</span></label>
                        <input type="text" id="equip-codigo" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none uppercase" placeholder="EQ-001" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nome <span class="text-red-500">*</span></label>
                        <input type="text" id="equip-nome" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Escavadeira CAT 320D" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Tipo</label>
                        <select id="equip-tipo" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="Escavadeira">Escavadeira</option>
                            <option value="Caminhão">Caminhão</option>
                            <option value="Trator">Trator</option>
                            <option value="Retroescavadeira">Retroescavadeira</option>
                            <option value="Pá Carregadeira">Pá Carregadeira</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Marca</label>
                        <input type="text" id="equip-marca" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Caterpillar">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Modelo</label>
                        <input type="text" id="equip-modelo" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="320D">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Ano de Fabricação</label>
                        <input type="number" id="equip-ano" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="2020">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Chassi/Série</label>
                        <input type="text" id="equip-chassi" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="XYZ123456">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                        <select id="equip-status" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="disponivel">Disponível</option>
                            <option value="operacao">Em Operação</option>
                            <option value="manutencao">Em Manutenção</option>
                            <option value="indisponivel">Indisponível</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Horímetro Atual</label>
                        <input type="number" id="equip-horimetro" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Próxima Manutenção (h)</label>
                        <input type="number" id="equip-proxima-manut" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="250">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Observações</label>
                    <textarea id="equip-obs" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Informações adicionais sobre o equipamento..."></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('equip-modal')" class="px-6 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Salvar Equipamento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Registro de Horímetro -->
    <div id="horimetro-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-enter">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-slate-800">Registrar Leitura de Horímetro</h3>
                <button onclick="closeModal('horimetro-modal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="horimetro-form" onsubmit="saveHorimetro(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Equipamento <span class="text-red-500">*</span></label>
                    <select id="horimetro-equipamento" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required onchange="updateHorimetroAtual()">
                        <option value="">Selecione...</option>
                    </select>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-600">Leitura Anterior:</span>
                        <span class="font-mono font-bold text-slate-800" id="horimetro-anterior">0h</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nova Leitura (h) <span class="text-red-500">*</span></label>
                    <input type="number" id="horimetro-leitura" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: 8540" required>
                    <p class="text-xs text-slate-500 mt-1">A leitura deve ser maior que a anterior</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Data <span class="text-red-500">*</span></label>
                    <input type="date" id="horimetro-data" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Operador/Responsável</label>
                    <input type="text" id="horimetro-operador" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome do operador">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Observações</label>
                    <textarea id="horimetro-obs" rows="2" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Observações opcionais..."></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('horimetro-modal')" class="px-6 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Registrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Histórico de Horímetro -->
    <div id="horimetro-history-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden modal-enter flex flex-col">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">Histórico de Horímetro</h3>
                    <p class="text-sm text-slate-500" id="hist-equip-nome">Escavadeira CAT 320D</p>
                </div>
                <button onclick="closeModal('horimetro-history-modal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
                <div class="flex items-center justify-between mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div>
                        <p class="text-sm text-blue-600">Horímetro Atual</p>
                        <p class="text-3xl font-bold text-blue-800" id="hist-horimetro-atual">8.540h</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-blue-600">Total de Registros</p>
                        <p class="text-xl font-bold text-blue-800" id="hist-total-registros">15</p>
                    </div>
                </div>
                
                <div class="relative">
                    <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-slate-200"></div>
                    <div class="space-y-6" id="hist-timeline">
                        <!-- Timeline items will be rendered here -->
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-slate-200 flex justify-end">
                <button onclick="exportHorimetroHistory()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Exportar Histórico
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Abastecimento -->
    <div id="combustivel-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg modal-enter">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-slate-800" id="combustivel-modal-title">Registrar Abastecimento</h3>
                <button onclick="closeModal('combustivel-modal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="combustivel-form" onsubmit="saveCombustivel(event)" class="p-6 space-y-4">
                <input type="hidden" id="combustivel-id">
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Equipamento <span class="text-red-500">*</span></label>
                    <select id="combustivel-equipamento" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Data <span class="text-red-500">*</span></label>
                        <input type="date" id="combustivel-data" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Horímetro/KM <span class="text-red-500">*</span></label>
                        <input type="number" id="combustivel-km" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Tipo de Combustível</label>
                        <select id="combustivel-tipo" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="Diesel S10">Diesel S10</option>
                            <option value="Diesel S500">Diesel S500</option>
                            <option value="Gasolina">Gasolina</option>
                            <option value="Etanol">Etanol</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Quantidade (L) <span class="text-red-500">*</span></label>
                        <input type="number" step="0.01" id="combustivel-quantidade" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0,00" required oninput="calcularTotalCombustivel()">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Valor por Litro (R$)</label>
                        <input type="number" step="0.01" id="combustivel-valor-unit" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0,00" oninput="calcularTotalCombustivel()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Valor Total (R$)</label>
                        <input type="number" step="0.01" id="combustivel-valor-total" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50" placeholder="0,00" readonly>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Fornecedor/Posto</label>
                    <input type="text" id="combustivel-fornecedor" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome do posto ou fornecedor">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Número da Nota Fiscal</label>
                    <input type="text" id="combustivel-nf" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="NF-e número">
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('combustivel-modal')" class="px-6 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Salvar Abastecimento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Técnico -->
    <div id="tecnico-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-enter">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-slate-800" id="tecnico-modal-title">Novo Técnico</h3>
                <button onclick="closeModal('tecnico-modal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="tecnico-form" onsubmit="saveTecnico(event)" class="p-6 space-y-6">
                <input type="hidden" id="tecnico-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nome Completo <span class="text-red-500">*</span></label>
                        <input type="text" id="tecnico-nome" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email <span class="text-red-500">*</span></label>
                        <input type="email" id="tecnico-email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Telefone</label>
                        <input type="tel" id="tecnico-telefone" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="(00) 00000-0000">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">CPF</label>
                        <input type="text" id="tecnico-cpf" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="000.000.000-00">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Especialidade</label>
                        <select id="tecnico-especialidade" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="Mecânica">Mecânica</option>
                            <option value="Elétrica">Elétrica</option>
                            <option value="Hidráulica">Hidráulica</option>
                            <option value="Pneumática">Pneumática</option>
                            <option value="Geral">Manutenção Geral</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Registro Profissional</label>
                        <input type="text" id="tecnico-registro" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Número do registro">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Endereço</label>
                    <input type="text" id="tecnico-endereco" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Rua, número, bairro, cidade">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Observações</label>
                    <textarea id="tecnico-obs" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                </div>
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="tecnico-ativo" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" checked>
                    <label for="tecnico-ativo" class="text-sm font-medium text-slate-700">Técnico Ativo</label>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('tecnico-modal')" class="px-6 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Salvar Técnico
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Peça -->
    <div id="peca-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-enter">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-slate-800" id="peca-modal-title">Nova Peça</h3>
                <button onclick="closeModal('peca-modal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="peca-form" onsubmit="savePeca(event)" class="p-6 space-y-6">
                <input type="hidden" id="peca-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Código/SKU <span class="text-red-500">*</span></label>
                        <input type="text" id="peca-codigo" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none uppercase" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nome da Peça <span class="text-red-500">*</span></label>
                        <input type="text" id="peca-nome" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Categoria</label>
                        <select id="peca-categoria" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="Filtros">Filtros</option>
                            <option value="Lubrificantes">Lubrificantes</option>
                            <option value="Peças Motor">Peças Motor</option>
                            <option value="Peças Hidráulicas">Peças Hidráulicas</option>
                            <option value="Eletrica">Elétrica</option>
                            <option value="Pneus">Pneus</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Fornecedor</label>
                        <input type="text" id="peca-fornecedor" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Quantidade em Estoque</label>
                        <input type="number" id="peca-quantidade" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Estoque Mínimo</label>
                        <input type="number" id="peca-minimo" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Unidade</label>
                        <select id="peca-unidade" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="un">Unidade</option>
                            <option value="kg">Quilograma</option>
                            <option value="l">Litro</option>
                            <option value="m">Metro</option>
                            <option value="par">Par</option>
                            <option value="jogo">Jogo</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Preço de Custo (R$)</label>
                        <input type="number" step="0.01" id="peca-custo" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0,00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Preço de Venda (R$)</label>
                        <input type="number" step="0.01" id="peca-venda" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0,00">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Localização no Estoque</label>
                    <input type="text" id="peca-localizacao" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Prateleira A-12, Corredor 3">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Descrição Técnica</label>
                    <textarea id="peca-descricao" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('peca-modal')" class="px-6 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Salvar Peça
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Análise de Custos por Contrato -->
    <div id="custos-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden modal-enter flex flex-col">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">Análise de Custos Detalhada</h3>
                    <p class="text-sm text-slate-500">Por Contrato/Obra</p>
                </div>
                <button onclick="closeModal('custos-modal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-200 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-600 mb-1">Custo Total</p>
                        <p class="text-2xl font-bold text-blue-800">R$ 245.890,00</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <p class="text-sm text-green-600 mb-1">Receita Total</p>
                        <p class="text-2xl font-bold text-green-800">R$ 380.000,00</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <p class="text-sm text-purple-600 mb-1">Lucro Líquido</p>
                        <p class="text-2xl font-bold text-purple-800">R$ 134.110,00</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <p class="text-sm text-orange-600 mb-1">Margem</p>
                        <p class="text-2xl font-bold text-orange-800">35,3%</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border border-slate-200 overflow-hidden mb-6">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="text-left px-4 py-3 font-semibold text-slate-700">Contrato/Obra</th>
                                <th class="text-right px-4 py-3 font-semibold text-slate-700">Peças</th>
                                <th class="text-right px-4 py-3 font-semibold text-slate-700">Mão de Obra</th>
                                <th class="text-right px-4 py-3 font-semibold text-slate-700">Combustível</th>
                                <th class="text-right px-4 py-3 font-semibold text-slate-700">Outros</th>
                                <th class="text-right px-4 py-3 font-semibold text-slate-700">Total</th>
                                <th class="text-center px-4 py-3 font-semibold text-slate-700">%</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="custos-contratos-list">
                            <!-- Rendered by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg border border-slate-200">
                        <h4 class="font-semibold text-slate-800 mb-4">Distribuição de Custos</h4>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-slate-600">Peças e Materiais</span>
                                    <span class="font-medium">R$ 98.356,00 (40%)</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: 40%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-slate-600">Mão de Obra</span>
                                    <span class="font-medium">R$ 73.767,00 (30%)</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 30%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-slate-600">Combustível</span>
                                    <span class="font-medium">R$ 49.178,00 (20%)</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div class="bg-orange-500 h-2 rounded-full" style="width: 20%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-slate-600">Outros</span>
                                    <span class="font-medium">R$ 24.589,00 (10%)</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div class="bg-purple-500 h-2 rounded-full" style="width: 10%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg border border-slate-200">
                        <h4 class="font-semibold text-slate-800 mb-4">Top 5 Equipamentos - Maior Custo</h4>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="truck" class="w-5 h-5 text-slate-400"></i>
                                    <span class="font-medium text-slate-700">Escavadeira CAT 320D</span>
                                </div>
                                <span class="font-bold text-slate-800">R$ 45.230,00</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="truck" class="w-5 h-5 text-slate-400"></i>
                                    <span class="font-medium text-slate-700">Caminhão Mercedes 2428</span>
                                </div>
                                <span class="font-bold text-slate-800">R$ 38.450,00</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="truck" class="w-5 h-5 text-slate-400"></i>
                                    <span class="font-medium text-slate-700">Trator John Deere</span>
                                </div>
                                <span class="font-bold text-slate-800">R$ 28.900,00</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="truck" class="w-5 h-5 text-slate-400"></i>
                                    <span class="font-medium text-slate-700">Retroescavadeira JCB</span>
                                </div>
                                <span class="font-bold text-slate-800">R$ 22.150,00</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="truck" class="w-5 h-5 text-slate-400"></i>
                                    <span class="font-medium text-slate-700">Pá Carregadeira Volvo</span>
                                </div>
                                <span class="font-bold text-slate-800">R$ 18.760,00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-slate-200 flex justify-end gap-3">
                <button onclick="exportCustos()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Exportar Excel
                </button>
                <button onclick="closeModal('custos-modal')" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <!-- User Modal (Admin) -->
    <div id="user-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-enter">
            <div class="p-6 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800" id="user-modal-title">Novo Usuário</h3>
                <button onclick="closeModal('user-modal')" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="user-form" onsubmit="saveUser(event)" class="p-6 space-y-4">
                <input type="hidden" id="user-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nome Completo</label>
                        <input type="text" id="user-nome" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="user-email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Perfil de Acesso</label>
                        <select id="user-perfil" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                            <option value="">Selecione...</option>
                            <option value="superadmin">Super Admin</option>
                            <option value="admin">Administrador</option>
                            <option value="gerente">Gerente</option>
                            <option value="tecnico">Técnico</option>
                            <option value="visualizador">Visualizador</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Telefone</label>
                        <input type="tel" id="user-telefone" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="(00) 00000-0000">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Senha</label>
                        <input type="password" id="user-senha" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Mínimo 6 caracteres">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Confirmar Senha</label>
                        <input type="password" id="user-senha-confirm" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Repita a senha">
                    </div>
                </div>
                <div class="flex items-center gap-2 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <input type="checkbox" id="user-ativo" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" checked>
                    <label for="user-ativo" class="text-sm font-medium text-slate-700">Usuário Ativo</label>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('user-modal')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Salvar Usuário
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- WhatsApp Modal -->
    <div id="whatsapp-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col modal-enter">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-green-600 text-white rounded-t-xl">
                <div class="flex items-center gap-3">
                    <i data-lucide="message-circle" class="w-6 h-6"></i>
                    <div>
                        <h3 class="font-bold">WhatsApp Business</h3>
                        <p class="text-xs text-green-100">Conectado • 3 conversas ativas</p>
                    </div>
                </div>
                <button onclick="toggleWhatsAppModal()" class="text-white/80 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/3 border-r border-slate-200 bg-slate-50 flex flex-col">
                    <div class="p-3 border-b border-slate-200">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                            <input type="text" placeholder="Buscar conversas..." class="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 outline-none">
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto" id="whatsapp-conversations"></div>
                </div>
                <div class="flex-1 flex flex-col bg-[#e5ddd5]">
                    <div class="p-3 bg-slate-100 border-b border-slate-300 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <i data-lucide="user" class="w-5 h-5 text-green-600"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-sm">João Silva - Operador</p>
                                <p class="text-xs text-green-600 flex items-center gap-1">
                                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                    Online
                                </p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="p-2 text-slate-600 hover:bg-slate-200 rounded-full"><i data-lucide="paperclip" class="w-5 h-5"></i></button>
                            <button class="p-2 text-slate-600 hover:bg-slate-200 rounded-full"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages"></div>
                    <div class="p-3 bg-slate-100 border-t border-slate-300 flex gap-2">
                        <button class="p-2 text-slate-600 hover:bg-slate-200 rounded-full"><i data-lucide="smile" class="w-6 h-6"></i></button>
                        <input type="text" placeholder="Digite uma mensagem..." class="flex-1 px-4 py-2 rounded-full border border-slate-300 focus:ring-2 focus:ring-green-500 outline-none">
                        <button class="p-2 bg-green-600 text-white rounded-full hover:bg-green-700 transition-colors"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA & STATE ====================
        
        const PERMISSIONS = {
            dashboard: { view: 'Visualizar Dashboard', create: 'Criar Widgets', edit: 'Editar Layout', delete: 'Remover Widgets', admin: 'Administrar Dashboard' },
            os: { view: 'Visualizar OS', create: 'Criar OS', edit: 'Editar OS', delete: 'Excluir OS', approve: 'Aprovar OS', export: 'Exportar OS' },
            equipamentos: { view: 'Visualizar Equipamentos', create: 'Cadastrar Equipamentos', edit: 'Editar Equipamentos', delete: 'Excluir Equipamentos', admin: 'Administrar Frota' },
            horimetro: { view: 'Visualizar Horímetro', create: 'Registrar Leitura', edit: 'Editar Leitura', delete: 'Excluir Registro', export: 'Exportar Dados' },
            combustivel: { view: 'Visualizar Abastecimentos', create: 'Registrar Abastecimento', edit: 'Editar Registro', delete: 'Excluir Registro', approve: 'Aprovar Lançamento' },
            pecas: { view: 'Visualizar Estoque', create: 'Cadastrar Peças', edit: 'Editar Peças', delete: 'Excluir Peças', admin: 'Administrar Estoque' },
            tecnicos: { view: 'Visualizar Técnicos', create: 'Cadastrar Técnicos', edit: 'Editar Técnicos', delete: 'Excluir Técnicos', admin: 'Gerenciar Equipes' },
            custos: { view: 'Visualizar Custos', create: 'Lançar Custos', edit: 'Editar Custos', delete: 'Excluir Custos', export: 'Exportar Relatórios', admin: 'Análise Financeira' },
            admin: { view: 'Acessar Admin', create: 'Criar Usuários', edit: 'Editar Usuários', delete: 'Excluir Usuários', admin: 'Super Admin' }
        };

        const PROFILES = {
            superadmin: { 
                name: 'Super Admin', 
                permissions: Object.keys(PERMISSIONS).reduce((acc, mod) => ({ ...acc, [mod]: ['view', 'create', 'edit', 'delete', 'approve', 'export', 'admin'] }), {}),
                color: 'bg-purple-100 text-purple-800',
                description: 'Acesso total ao sistema'
            },
            admin: { 
                name: 'Administrador', 
                permissions: Object.keys(PERMISSIONS).reduce((acc, mod) => ({ ...acc, [mod]: ['view', 'create', 'edit', 'delete', 'approve', 'export'] }), {}),
                color: 'bg-blue-100 text-blue-800',
                description: 'Gestão completa exceto configurações críticas'
            },
            gerente: { 
                name: 'Gerente', 
                permissions: {
                    dashboard: ['view', 'create', 'edit'],
                    os: ['view', 'create', 'edit', 'approve', 'export'],
                    equipamentos: ['view', 'create', 'edit', 'admin'],
                    horimetro: ['view', 'create', 'edit', 'export'],
                    combustivel: ['view', 'create', 'edit', 'approve'],
                    pecas: ['view', 'create', 'edit'],
                    tecnicos: ['view', 'create', 'edit'],
                    custos: ['view', 'create', 'edit', 'export', 'admin'],
                    admin: []
                },
                color: 'bg-green-100 text-green-800',
                description: 'Gestão operacional e financeira'
            },
            tecnico: { 
                name: 'Técnico', 
                permissions: {
                    dashboard: ['view'],
                    os: ['view', 'create', 'edit'],
                    equipamentos: ['view', 'edit'],
                    horimetro: ['view', 'create'],
                    combustivel: ['view', 'create'],
                    pecas: ['view', 'create', 'edit'],
                    tecnicos: ['view'],
                    custos: ['view'],
                    admin: []
                },
                color: 'bg-yellow-100 text-yellow-800',
                description: 'Execução de manutenções e registros'
            },
            visualizador: { 
                name: 'Visualizador', 
                permissions: {
                    dashboard: ['view'],
                    os: ['view'],
                    equipamentos: ['view'],
                    horimetro: ['view'],
                    combustivel: ['view'],
                    pecas: ['view'],
                    tecnicos: ['view'],
                    custos: ['view', 'export'],
                    admin: []
                },
                color: 'bg-gray-100 text-gray-800',
                description: 'Apenas visualização e relatórios'
            }
        };

        let currentUser = null;
        let users = [
            { id: 1, nome: 'Administrador Master', email: 'admin@heavymaint.com', perfil: 'superadmin', telefone: '(11) 99999-9999', ativo: true, ultimoAcesso: '2024-01-15 10:30', createdAt: '2024-01-01' },
            { id: 2, nome: 'Carlos Gerente', email: 'gerente@heavymaint.com', perfil: 'gerente', telefone: '(11) 98888-8888', ativo: true, ultimoAcesso: '2024-01-15 09:15', createdAt: '2024-01-05' },
            { id: 3, nome: 'Técnico Silva', email: 'tecnico@heavymaint.com', perfil: 'tecnico', telefone: '(11) 97777-7777', ativo: true, ultimoAcesso: '2024-01-14 18:45', createdAt: '2024-01-10' },
            { id: 4, nome: 'Maria Visualizador', email: 'visualizador@heavymaint.com', perfil: 'visualizador', telefone: '(11) 96666-6666', ativo: false, ultimoAcesso: '2024-01-10 14:20', createdAt: '2024-01-12' }
        ];

        let tecnicos = [
            { id: 1, nome: 'João Silva', email: 'joao.silva@email.com', telefone: '(11) 99999-1111', especialidade: 'Mecânica', ativo: true, cpf: '123.456.789-00', registro: 'MEC-001' },
            { id: 2, nome: 'Pedro Costa', email: 'pedro.costa@email.com', telefone: '(11) 99999-2222', especialidade: 'Elétrica', ativo: true, cpf: '987.654.321-00', registro: 'ELE-002' },
            { id: 3, nome: 'Marcos Oliveira', email: 'marcos.oliveira@email.com', telefone: '(11) 99999-3333', especialidade: 'Hidráulica', ativo: true, cpf: '456.789.123-00', registro: 'HID-003' }
        ];

        let pecas = [
            { id: 1, codigo: 'FIL-001', nome: 'Filtro de Óleo Motor', categoria: 'Filtros', quantidade: 15, minimo: 5, unidade: 'un', custo: 45.00, venda: 89.90, fornecedor: 'AutoPeças Ltda', localizacao: 'A-12' },
            { id: 2, codigo: 'LUB-001', nome: 'Óleo Lubrificante 15W40', categoria: 'Lubrificantes', quantidade: 200, minimo: 50, unidade: 'l', custo: 25.00, venda: 45.00, fornecedor: 'Lubrificantes BR', localizacao: 'B-05' },
            { id: 3, codigo: 'PNE-001', nome: 'Pneu 295/80R22.5', categoria: 'Pneus', quantidade: 8, minimo: 4, unidade: 'un', custo: 1200.00, venda: 1850.00, fornecedor: 'Pneus Total', localizacao: 'C-01' }
        ];

        let securityLogs = [
            { id: 1, usuario: 'admin@heavymaint.com', acao: 'LOGIN', modulo: 'Sistema', status: 'SUCESSO', ip: '192.168.1.100', timestamp: '2024-01-15 10:30:22', detalhes: 'Login via Web' },
            { id: 2, usuario: 'gerente@heavymaint.com', acao: 'CREATE', modulo: 'OS', status: 'SUCESSO', ip: '192.168.1.101', timestamp: '2024-01-15 09:15:10', detalhes: 'Criou OS #1234' },
            { id: 3, usuario: 'tecnico@heavymaint.com', acao: 'UPDATE', modulo: 'Horimetro', status: 'SUCESSO', ip: '192.168.1.102', timestamp: '2024-01-14 18:45:33', detalhes: 'Registrou horímetro EQ-001' },
            { id: 4, usuario: 'unknown', acao: 'LOGIN', modulo: 'Sistema', status: 'FALHA', ip: '45.123.45.67', timestamp: '2024-01-15 08:20:15', detalhes: 'Tentativa de acesso não autorizado' },
            { id: 5, usuario: 'admin@heavymaint.com', acao: 'DELETE', modulo: 'Usuários', status: 'SUCESSO', ip: '192.168.1.100', timestamp: '2024-01-15 11:05:44', detalhes: 'Excluiu usuário ID 5' }
        ];

        let systemConfig = {
            geral: { empresa: 'HeavyMaint Pro', idioma: 'pt-BR', timezone: 'America/Sao_Paulo', formatoData: 'DD/MM/YYYY' },
            seguranca: { politicaSenha: 'strong', minCaracteres: 8, exigirMaiuscula: true, exigirNumero: true, exigirSimbolo: true, tentativasLogin: 3, bloqueioMinutos: 30, sessaoTimeout: 60, doisFatores: false },
            notificacoes: { email: true, sms: false, push: true, alertasCriticos: true, resumoDiario: true },
            manutencao: { modoManutencao: false, mensagemManutencao: 'Sistema em manutenção. Voltamos em breve!', backupAutomatico: true, frequenciaBackup: 'daily' }
        };

        let osData = [
            { id: 'OS-2024-001', titulo: 'Troca de óleo Escavadeira CAT', equipamento: 'EQ-001', status: 'aberta', prioridade: 'alta', data: '2024-01-15', previsao: '2024-01-20', conclusao: null, responsavel: 'Técnico Silva', tipo: 'Preventiva', descricao: 'Troca de óleo do motor e filtros conforme programa de manutenção preventiva.', pecas: [{nome: 'Óleo Lubrificante 15W40', qtd: 20, valor: 45.00}, {nome: 'Filtro de Óleo', qtd: 1, valor: 120.00}] },
            { id: 'OS-2024-002', titulo: 'Reparo Sistema Hidráulico', equipamento: 'EQ-002', status: 'andamento', prioridade: 'critica', data: '2024-01-14', previsao: '2024-01-16', conclusao: null, responsavel: 'João Mecânico', tipo: 'Corretiva', descricao: 'Vazamento no cilindro hidráulico principal.', pecas: [] },
            { id: 'OS-2024-003', titulo: 'Revisão 1000h Trator', equipamento: 'EQ-003', status: 'finalizada', prioridade: 'media', data: '2024-01-10', previsao: '2024-01-12', conclusao: '2024-01-12', responsavel: 'Técnico Silva', tipo: 'Preventiva', descricao: 'Revisão completa conforme manual do fabricante.', pecas: [] }
        ];

        let equipamentosData = [
            { id: 'EQ-001', nome: 'Escavadeira CAT 320D', tipo: 'Escavadeira', marca: 'Caterpillar', modelo: '320D', ano: 2020, chassi: 'CAT0320D12345', status: 'operacao', horimetro: 8540, proximaManutencao: 9000, alerta: 'warning', obs: 'Equipamento principal da frota' },
            { id: 'EQ-002', nome: 'Caminhão Mercedes 2428', tipo: 'Caminhão', marca: 'Mercedes-Benz', modelo: '2428', ano: 2019, chassi: 'MB2428ABC789', status: 'disponivel', horimetro: 12500, proximaManutencao: 13000, alerta: 'ok', obs: '' },
            { id: 'EQ-003', nome: 'Trator John Deere 6110J', tipo: 'Trator', marca: 'John Deere', modelo: '6110J', ano: 2021, chassi: 'JD6110JXYZ456', status: 'manutencao', horimetro: 4200, proximaManutencao: 4200, alerta: 'danger', obs: 'Em revisão programada' }
        ];

        let horimetroData = [
            { id: 1, equipamento: 'EQ-001', leitura: 8540, data: '2024-01-15', operador: 'João Silva', diferenca: 8, obs: 'Turno normal' },
            { id: 2, equipamento: 'EQ-002', leitura: 12500, data: '2024-01-15', operador: 'Pedro Costa', diferenca: 12, obs: '' },
            { id: 3, equipamento: 'EQ-001', leitura: 8532, data: '2024-01-14', operador: 'João Silva', diferenca: 9, obs: '' },
            { id: 4, equipamento: 'EQ-001', leitura: 8523, data: '2024-01-13', operador: 'Maria Santos', diferenca: 8, obs: 'Manutenção rápida' }
        ];

        let combustivelData = [
            { id: 1, equipamento: 'EQ-002', quantidade: 150, valorUnit: 6.50, valorTotal: 975.00, data: '2024-01-15', km: 12500, tipo: 'Diesel S10', fornecedor: 'Posto Shell', nf: '123456' },
            { id: 2, equipamento: 'EQ-001', quantidade: 200, valorUnit: 6.50, valorTotal: 1300.00, data: '2024-01-14', km: 8532, tipo: 'Diesel S500', fornecedor: 'Posto Ipiranga', nf: '123455' }
        ];

        let custosContratos = [
            { contrato: 'Obra Centro Empresarial', pecas: 45320.00, maoObra: 28500.00, combustivel: 18200.00, outros: 8500.00, total: 100520.00 },
            { contrato: 'Manutenção Rodovia BR-101', pecas: 32100.00, maoObra: 24500.00, combustivel: 15600.00, outros: 4200.00, total: 76400.00 },
            { contrato: 'Terraplanagem Loteamento', pecas: 20936.00, maoObra: 20767.00, combustivel: 15378.00, outros: 12889.00, total: 69970.00 }
        ];

        let whatsappConversations = [
            { id: 1, nome: 'João Silva - Operador', mensagem: 'Bom dia! O equipamento ESC-001 está com...', hora: '10:30', naoLidas: 2, online: true },
            { id: 2, nome: 'Oficina Central', mensagem: 'Peças solicitadas chegaram hoje.', hora: '09:15', naoLidas: 0, online: false },
            { id: 3, nome: 'Carlos Gerente', mensagem: 'Preciso do relatório de custos', hora: 'Ontem', naoLidas: 1, online: true }
        ];

        // ==================== AUTHENTICATION ====================

        function fillLogin(email, password) {
            document.getElementById('login-email').value = email;
            document.getElementById('login-password').value = password;
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            const validUsers = {
                'admin@heavymaint.com': { password: '123456', profile: 'superadmin', name: 'Administrador Master' },
                'gerente@heavymaint.com': { password: '123456', profile: 'gerente', name: 'Carlos Gerente' },
                'tecnico@heavymaint.com': { password: '123456', profile: 'tecnico', name: 'Técnico Silva' },
                'visualizador@heavymaint.com': { password: '123456', profile: 'visualizador', name: 'Maria Visualizador' }
            };

            if (validUsers[email] && validUsers[email].password === password) {
                const userData = validUsers[email];
                currentUser = {
                    email: email,
                    nome: userData.name,
                    perfil: userData.profile,
                    permissions: PROFILES[userData.profile].permissions
                };
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                addSecurityLog(email, 'LOGIN', 'Sistema', 'SUCESSO', 'Login via Web');
                
                document.getElementById('login-screen').classList.add('section-hidden');
                document.getElementById('main-app').classList.remove('section-hidden');
                
                initApp();
            } else {
                addSecurityLog(email, 'LOGIN', 'Sistema', 'FALHA', 'Credenciais inválidas');
                alert('Credenciais inválidas! Tente novamente.');
            }
        }

        function logout() {
            if (currentUser) {
                addSecurityLog(currentUser.email, 'LOGOUT', 'Sistema', 'SUCESSO', 'Logout manual');
            }
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('main-app').classList.add('section-hidden');
            document.getElementById('login-screen').classList.remove('section-hidden');
            document.getElementById('login-form').reset();
        }

        function checkSession() {
            const saved = localStorage.getItem('currentUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                document.getElementById('login-screen').classList.add('section-hidden');
                document.getElementById('main-app').classList.remove('section-hidden');
                initApp();
            }
        }

        // ==================== INITIALIZATION ====================

        function initApp() {
            renderSidebar();
            updateUserInfo();
            navigateTo('dashboard');
            lucide.createIcons();
        }

        function updateUserInfo() {
            document.getElementById('user-name').textContent = currentUser.nome;
            document.getElementById('user-role').textContent = PROFILES[currentUser.perfil].name;
            document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.nome)}&background=3b82f6&color=fff`;
        }

        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const perms = currentUser.permissions;
            
            let html = '';
            
            html += '<div class="px-4 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Principal</div>';
            
            if (perms.dashboard && perms.dashboard.includes('view')) {
                html += createNavItem('dashboard', 'layout-dashboard', 'Dashboard');
            }
            if (perms.os && perms.os.includes('view')) {
                const badge = osData.filter(o => o.status === 'aberta').length;
                html += createNavItem('os', 'clipboard-list', 'Ordens de Serviço', badge > 0 ? badge : null);
            }
            if (perms.equipamentos && perms.equipamentos.includes('view')) {
                html += createNavItem('equipamentos', 'truck', 'Equipamentos');
            }
            if (perms.horimetro && perms.horimetro.includes('view')) {
                html += createNavItem('horimetro', 'gauge', 'Controle de Horímetro');
            }
            if (perms.combustivel && perms.combustivel.includes('view')) {
                html += createNavItem('combustivel', 'fuel', 'Combustível');
            }

            html += '<div class="px-4 mt-6 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Cadastros</div>';
            
            if (perms.pecas && perms.pecas.includes('view')) {
                html += createNavItem('pecas', 'package', 'Peças e Estoque');
            }
            if (perms.tecnicos && perms.tecnicos.includes('view')) {
                html += createNavItem('tecnicos', 'users', 'Técnicos');
            }

            html += '<div class="px-4 mt-6 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Relatórios</div>';
            
            if (perms.custos && perms.custos.includes('view')) {
                html += createNavItem('custos', 'pie-chart', 'Análise de Custos');
            }

            if (perms.admin && perms.admin.includes('view')) {
                html += '<div class="px-4 mt-6 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Administração</div>';
                html += createNavItem('admin', 'shield', 'Admin & Segurança', 'ADM', 'bg-purple-500');
            }

            nav.innerHTML = html;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    navigateTo(section);
                });
            });
        }

        function createNavItem(section, icon, label, badge = null, badgeColor = 'bg-red-500') {
            return `
                <a href="#" class="nav-item flex items-center gap-3 px-6 py-3 hover:bg-slate-800 transition-colors border-l-4 border-transparent" data-section="${section}">
                    <i data-lucide="${icon}" class="w-5 h-5"></i>
                    <span>${label}</span>
                    ${badge ? `<span class="ml-auto ${badgeColor} text-xs px-2 py-0.5 rounded-full">${badge}</span>` : ''}
                </a>
            `;
        }

        // ==================== NAVIGATION ====================

        function navigateTo(section) {
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.section === section) {
                    item.classList.add('active');
                    item.classList.remove('border-transparent');
                    item.classList.add('border-blue-500');
                } else {
                    item.classList.remove('active');
                    item.classList.add('border-transparent');
                    item.classList.remove('border-blue-500');
                }
            });

            const titles = {
                dashboard: { title: 'Dashboard', subtitle: 'Visão geral do sistema' },
                os: { title: 'Ordens de Serviço', subtitle: 'Gestão de manutenções' },
                equipamentos: { title: 'Equipamentos', subtitle: 'Controle da frota' },
                horimetro: { title: 'Controle de Horímetro', subtitle: 'Monitoramento de uso' },
                combustivel: { title: 'Combustível', subtitle: 'Abastecimentos e consumo' },
                pecas: { title: 'Peças e Estoque', subtitle: 'Gestão de inventário' },
                tecnicos: { title: 'Técnicos', subtitle: 'Equipe técnica' },
                custos: { title: 'Análise de Custos', subtitle: 'Relatórios financeiros' },
                admin: { title: 'Administração', subtitle: 'Segurança e configurações' }
            };

            if (titles[section]) {
                document.getElementById('page-title').textContent = titles[section].title;
                document.getElementById('page-subtitle').textContent = titles[section].subtitle;
            }

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '';

            switch(section) {
                case 'dashboard':
                    renderDashboard(contentArea);
                    break;
                case 'os':
                    renderOS(contentArea);
                    break;
                case 'equipamentos':
                    renderEquipamentos(contentArea);
                    break;
                case 'horimetro':
                    renderHorimetro(contentArea);
                    break;
                case 'combustivel':
                    renderCombustivel(contentArea);
                    break;
                case 'pecas':
                    renderPecas(contentArea);
                    break;
                case 'tecnicos':
                    renderTecnicos(contentArea);
                    break;
                case 'custos':
                    renderCustos(contentArea);
                    break;
                case 'admin':
                    renderAdmin(contentArea);
                    break;
            }

            lucide.createIcons();
        }

        // ==================== RENDER FUNCTIONS ====================

        function renderDashboard(container) {
            const perms = currentUser.permissions;
            
            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 card-hover cursor-pointer" onclick="navigateTo('os')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-slate-500 mb-1">OS em Aberto</p>
                                <h3 class="text-3xl font-bold text-slate-800">${osData.filter(o => o.status === 'aberta').length}</h3>
                            </div>
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <i data-lucide="alert-circle" class="w-6 h-6 text-yellow-600"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-yellow-600">
                            <i data-lucide="trending-up" class="w-4 h-4 mr-1"></i>
                            <span>3 novas hoje</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 card-hover cursor-pointer" onclick="navigateTo('equipamentos')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-slate-500 mb-1">Equipamentos</p>
                                <h3 class="text-3xl font-bold text-slate-800">${equipamentosData.length}</h3>
                            </div>
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i data-lucide="truck" class="w-6 h-6 text-blue-600"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-blue-600">
                            <span>${equipamentosData.filter(e => e.status === 'manutencao').length} em manutenção</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 card-hover cursor-pointer" onclick="navigateTo('horimetro')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-slate-500 mb-1">Horímetro Hoje</p>
                                <h3 class="text-3xl font-bold text-slate-800">24h</h3>
                            </div>
                            <div class="p-2 bg-green-100 rounded-lg">
                                <i data-lucide="gauge" class="w-6 h-6 text-green-600"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-green-600">
                            <span>Última atualização: 10:30</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 card-hover cursor-pointer" onclick="navigateTo('combustivel')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-slate-500 mb-1">Consumo Diesel</p>
                                <h3 class="text-3xl font-bold text-slate-800">850L</h3>
                            </div>
                            <div class="p-2 bg-orange-100 rounded-lg">
                                <i data-lucide="fuel" class="w-6 h-6 text-orange-600"></i>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-orange-600">
                            <span>R$ 5.525,00 em abastecimentos</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="lg:col-span-2 bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-4">Status dos Equipamentos</h3>
                        <div class="h-64 flex items-end justify-around gap-2">
                            ${renderChartBars()}
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-500"></i>
                            Alertas de Manutenção
                        </h3>
                        <div class="space-y-3">
                            ${equipamentosData.filter(e => e.alerta !== 'ok').map(eq => `
                                <div class="flex items-center gap-3 p-3 ${eq.alerta === 'danger' ? 'bg-red-50 border-l-4 border-red-500' : 'bg-orange-50 border-l-4 border-orange-500'} rounded-r-lg">
                                    <div class="flex-1">
                                        <p class="font-semibold text-sm ${eq.alerta === 'danger' ? 'text-red-800' : 'text-orange-800'}">${eq.nome}</p>
                                        <p class="text-xs ${eq.alerta === 'danger' ? 'text-red-600' : 'text-orange-600'}">
                                            ${eq.alerta === 'danger' ? 'Manutenção urgente!' : `Faltam ${eq.proximaManutencao - eq.horimetro}h`}
                                        </p>
                                    </div>
                                    <button onclick="navigateTo('equipamentos')" class="text-xs ${eq.alerta === 'danger' ? 'text-red-600 hover:text-red-800' : 'text-orange-600 hover:text-orange-800'} font-medium">Ver</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">Atividades Recentes</h3>
                        <button class="text-sm text-blue-600 hover:text-blue-700 font-medium">Ver todas</button>
                    </div>
                    <div class="divide-y divide-slate-100">
                        ${securityLogs.slice(0, 5).map(log => `
                            <div class="p-4 flex items-center gap-4 hover:bg-slate-50 transition-colors">
                                <div class="w-10 h-10 rounded-full ${log.status === 'SUCESSO' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} flex items-center justify-center">
                                    <i data-lucide="${log.acao === 'LOGIN' ? 'log-in' : log.acao === 'CREATE' ? 'plus' : log.acao === 'UPDATE' ? 'edit' : 'trash-2'}" class="w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-slate-800">${log.detalhes}</p>
                                    <p class="text-sm text-slate-500">${log.usuario} • ${log.modulo}</p>
                                </div>
                                <span class="text-xs text-slate-400">${log.timestamp.split(' ')[1]}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function renderChartBars() {
            const status = { disponivel: 0, operacao: 0, manutencao: 0, indisponivel: 0 };
            equipamentosData.forEach(eq => status[eq.status]++);
            
            const max = Math.max(...Object.values(status));
            const colors = { disponivel: 'bg-green-500', operacao: 'bg-blue-500', manutencao: 'bg-yellow-500', indisponivel: 'bg-red-500' };
            const labels = { disponivel: 'Disponível', operacao: 'Em Operação', manutencao: 'Manutenção', indisponivel: 'Indisponível' };
            
            return Object.entries(status).map(([key, value]) => `
                <div class="flex flex-col items-center gap-2 flex-1">
                    <div class="w-full bg-slate-100 rounded-t-lg relative h-48 overflow-hidden">
                        <div class="${colors[key]} absolute bottom-0 w-full transition-all duration-1000 rounded-t-lg" style="height: ${max > 0 ? (value / max * 100) : 0}%"></div>
                        <div class="absolute inset-0 flex items-center justify-center font-bold text-white text-shadow">${value}</div>
                    </div>
                    <span class="text-xs text-slate-600 text-center">${labels[key]}</span>
                </div>
            `).join('');
        }

        function renderOS(container) {
            const perms = currentUser.permissions.os || [];
            
            container.innerHTML = `
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex gap-2">
                        ${perms.includes('create') ? `
                            <button onclick="openOSModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Nova OS
                            </button>
                        ` : ''}
                        <button onclick="exportOS()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exportar
                        </button>
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <div class="relative flex-1 sm:flex-none">
                            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="os-search" placeholder="Buscar OS..." class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-full sm:w-64" onkeyup="filterOS()">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-t-xl border-b border-slate-200 flex">
                    <button onclick="filterOSByStatus('all')" class="os-tab active px-6 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 hover:bg-slate-50 transition-colors" data-status="all">Todas</button>
                    <button onclick="filterOSByStatus('aberta')" class="os-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:bg-slate-50 transition-colors" data-status="aberta">Abertas</button>
                    <button onclick="filterOSByStatus('andamento')" class="os-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:bg-slate-50 transition-colors" data-status="andamento">Em Andamento</button>
                    <button onclick="filterOSByStatus('finalizada')" class="os-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:bg-slate-50 transition-colors" data-status="finalizada">Concluídas</button>
                </div>

                <div class="bg-white rounded-b-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">OS</th>
                                    <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Título</th>
                                    <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Equipamento</th>
                                    <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Status</th>
                                    <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Prioridade</th>
                                    <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Responsável</th>
                                    <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="os-table-body">
                                ${renderOSTableRows(osData)}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderOSTableRows(data) {
            const perms = currentUser.permissions.os || [];
            
            return data.map(os => {
                const statusColors = {
                    aberta: 'bg-yellow-100 text-yellow-800',
                    andamento: 'bg-blue-100 text-blue-800',
                    finalizada: 'bg-green-100 text-green-800',
                    cancelada: 'bg-gray-100 text-gray-800'
                };
                const statusLabels = { aberta: 'Aberta', andamento: 'Em Andamento', finalizada: 'Finalizada', cancelada: 'Cancelada' };
                
                const priorityColors = {
                    baixa: 'bg-gray-100 text-gray-800',
                    media: 'bg-blue-100 text-blue-800',
                    alta: 'bg-orange-100 text-orange-800',
                    critica: 'bg-red-100 text-red-800'
                };
                
                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 font-mono text-sm font-medium text-slate-900">${os.id}</td>
                        <td class="px-6 py-4 text-sm text-slate-700">${os.titulo}</td>
                        <td class="px-6 py-4 text-sm text-slate-600">${os.equipamento}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColors[os.status]}">${statusLabels[os.status]}</span></td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs font-semibold ${priorityColors[os.prioridade] || priorityColors.media}">${os.prioridade.toUpperCase()}</span></td>
                        <td class="px-6 py-4 text-sm text-slate-600">${os.responsavel}</td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="viewOS('${os.id}')" class="p-1 text-blue-600 hover:bg-blue-50 rounded" title="Visualizar"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                ${perms.includes('edit') && os.status !== 'finalizada' ? `<button onclick="editOS('${os.id}')" class="p-1 text-orange-600 hover:bg-orange-50 rounded" title="Editar"><i data-lucide="edit" class="w-4 h-4"></i></button>` : ''}
                                ${perms.includes('edit') && os.status === 'aberta' ? `<button onclick="startOS('${os.id}')" class="p-1 text-blue-600 hover:bg-blue-50 rounded" title="Iniciar"><i data-lucide="play" class="w-4 h-4"></i></button>` : ''}
                                ${perms.includes('edit') && os.status === 'andamento' ? `<button onclick="completeOS('${os.id}')" class="p-1 text-green-600 hover:bg-green-50 rounded" title="Concluir"><i data-lucide="check-circle" class="w-4 h-4"></i></button>` : ''}
                                ${perms.includes('delete') ? `<button onclick="deleteOS('${os.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderEquipamentos(container) {
            const perms = currentUser.permissions.equipamentos || [];
            
            container.innerHTML = `
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex gap-2">
                        ${perms.includes('create') ? `
                            <button onclick="openEquipModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Novo Equipamento
                            </button>
                        ` : ''}
                    </div>
                    <div class="flex gap-2">
                        <select id="eq-status-filter" onchange="filterEquip()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Todos os status</option>
                            <option value="disponivel">Disponível</option>
                            <option value="operacao">Em Operação</option>
                            <option value="manutencao">Em Manutenção</option>
                            <option value="indisponivel">Indisponível</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="equip-grid">
                    ${renderEquipCards(equipamentosData)}
                </div>
            `;
        }

        function renderEquipCards(data) {
            const perms = currentUser.permissions.equipamentos || [];
            
            return data.map(eq => {
                const statusConfig = {
                    disponivel: { label: 'Disponível', color: 'bg-green-100 text-green-800', icon: 'check-circle' },
                    operacao: { label: 'Em Operação', color: 'bg-blue-100 text-blue-800', icon: 'play' },
                    manutencao: { label: 'Manutenção', color: 'bg-yellow-100 text-yellow-800', icon: 'wrench' },
                    indisponivel: { label: 'Indisponível', color: 'bg-red-100 text-red-800', icon: 'x-circle' }
                };
                const status = statusConfig[eq.status];
                const alertColor = eq.alerta === 'danger' ? 'text-red-600' : eq.alerta === 'warning' ? 'text-orange-600' : 'text-green-600';
                
                return `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden card-hover">
                        <div class="h-32 bg-slate-200 relative flex items-center justify-center">
                            <i data-lucide="truck" class="w-16 h-16 text-slate-400"></i>
                            <div class="absolute top-4 right-4">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${status.color} flex items-center gap-1">
                                    <i data-lucide="${status.icon}" class="w-3 h-3"></i>
                                    ${status.label}
                                </span>
                            </div>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-lg text-slate-800 mb-1">${eq.nome}</h3>
                            <p class="text-sm text-slate-500 mb-4">${eq.id} • ${eq.tipo}</p>
                            
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-600">Horímetro:</span>
                                    <span class="font-semibold ${alertColor}">${eq.horimetro}h</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-600">Próx. Revisão:</span>
                                    <span class="font-semibold">${eq.proximaManutencao}h</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${Math.min((eq.horimetro / eq.proximaManutencao * 100), 100)}%"></div>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 pt-4 border-t border-slate-100">
                                <button onclick="viewEquip('${eq.id}')" class="flex-1 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">Detalhes</button>
                                ${perms.includes('edit') ? `
                                    <select onchange="changeEquipStatus('${eq.id}', this.value)" class="text-sm border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                                        <option value="">Alterar Status</option>
                                        <option value="disponivel">Disponível</option>
                                        <option value="operacao">Em Operação</option>
                                        <option value="manutencao">Manutenção</option>
                                        <option value="indisponivel">Indisponível</option>
                                    </select>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderHorimetro(container) {
            container.innerHTML = `
                <div class="mb-6 flex justify-between items-center">
                    <button onclick="openHorimetroModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Registrar Leitura
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    ${equipamentosData.map(eq => {
                        const percent = (eq.horimetro / eq.proximaManutencao * 100);
                        const alertClass = percent >= 95 ? 'horimetro-alert' : percent >= 80 ? 'horimetro-warning' : 'horimetro-ok';
                        const alertIcon = percent >= 95 ? 'alert-circle' : percent >= 80 ? 'alert-triangle' : 'check-circle';
                        
                        return `
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200 ${alertClass}">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-bold text-slate-800">${eq.nome}</h3>
                                        <p class="text-sm text-slate-500">${eq.id}</p>
                                    </div>
                                    <i data-lucide="${alertIcon}" class="w-6 h-6 ${percent >= 95 ? 'text-red-500' : percent >= 80 ? 'text-orange-500' : 'text-green-500'}"></i>
                                </div>
                                <div class="mb-4">
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-slate-600">Horímetro Atual</span>
                                        <span class="font-bold text-lg">${eq.horimetro}h</span>
                                    </div>
                                    <div class="w-full bg-slate-200 rounded-full h-3">
                                        <div class="${percent >= 95 ? 'bg-red-500' : percent >= 80 ? 'bg-orange-500' : 'bg-green-500'} h-3 rounded-full transition-all" style="width: ${Math.min(percent, 100)}%"></div>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">Próxima revisão: ${eq.proximaManutencao}h (${eq.proximaManutencao - eq.horimetro}h restantes)</p>
                                </div>
                                <button onclick="viewHorimetroHistory('${eq.id}')" class="w-full py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Ver Histórico</button>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-200">
                        <h3 class="font-bold text-slate-800">Últimas Leituras</h3>
                    </div>
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Equipamento</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Leitura</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Data</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Operador</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Diferença</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${horimetroData.map(h => `
                                <tr class="hover:bg-slate-50">
                                    <td class="px-6 py-4 font-medium text-slate-900">${h.equipamento}</td>
                                    <td class="px-6 py-4 font-mono text-slate-700">${h.leitura}h</td>
                                    <td class="px-6 py-4 text-sm text-slate-600">${h.data}</td>
                                    <td class="px-6 py-4 text-sm text-slate-600">${h.operador}</td>
                                    <td class="px-6 py-4"><span class="text-green-600 font-medium">+${h.diferenca}h</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderCombustivel(container) {
            container.innerHTML = `
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <button onclick="openCombustivelModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Registrar Abastecimento
                    </button>
                    <div class="text-right">
                        <p class="text-sm text-slate-500">Consumo Total (Mês)</p>
                        <p class="text-2xl font-bold text-slate-800">R$ 12.450,00</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Data</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Equipamento</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Tipo</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Quantidade</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Valor Total</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${combustivelData.map(c => `
                                <tr class="hover:bg-slate-50">
                                    <td class="px-6 py-4 text-sm text-slate-700">${c.data}</td>
                                    <td class="px-6 py-4 font-medium text-slate-900">${c.equipamento}</td>
                                    <td class="px-6 py-4 text-sm text-slate-600">${c.tipo}</td>
                                    <td class="px-6 py-4 text-sm text-slate-700">${c.quantidade}L</td>
                                    <td class="px-6 py-4 font-medium text-slate-900">R$ ${c.valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                    <td class="px-6 py-4">
                                        <div class="flex gap-2">
                                            <button onclick="editCombustivel(${c.id})" class="p-1 text-blue-600 hover:bg-blue-50 rounded"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                            <button onclick="deleteCombustivel(${c.id})" class="p-1 text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPecas(container) {
            const perms = currentUser.permissions.pecas || [];
            
            container.innerHTML = `
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex gap-2">
                        ${perms.includes('create') ? `
                            <button onclick="openPecaModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Nova Peça
                            </button>
                        ` : ''}
                    </div>
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="peca-search" placeholder="Buscar peças..." class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-64" onkeyup="filterPecas()">
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Código</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Nome</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Categoria</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Estoque</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Preço Venda</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="pecas-table-body">
                            ${renderPecasTableRows(pecas)}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPecasTableRows(data) {
            const perms = currentUser.permissions.pecas || [];
            
            return data.map(peca => {
                const estoqueClass = peca.quantidade <= peca.minimo ? 'text-red-600 font-bold' : 'text-slate-700';
                const estoqueBadge = peca.quantidade <= peca.minimo ? '<span class="ml-2 px-2 py-0.5 bg-red-100 text-red-600 text-xs rounded-full">Crítico</span>' : '';
                
                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 font-mono text-sm font-medium text-slate-900">${peca.codigo}</td>
                        <td class="px-6 py-4 text-sm text-slate-700">${peca.nome}</td>
                        <td class="px-6 py-4 text-sm text-slate-600">${peca.categoria}</td>
                        <td class="px-6 py-4 text-sm ${estoqueClass}">${peca.quantidade} ${peca.unidade}${estoqueBadge}</td>
                        <td class="px-6 py-4 text-sm font-medium text-slate-900">R$ ${peca.venda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="viewPeca(${peca.id})" class="p-1 text-blue-600 hover:bg-blue-50 rounded" title="Visualizar"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                ${perms.includes('edit') ? `<button onclick="editPeca(${peca.id})" class="p-1 text-orange-600 hover:bg-orange-50 rounded" title="Editar"><i data-lucide="edit" class="w-4 h-4"></i></button>` : ''}
                                ${perms.includes('delete') ? `<button onclick="deletePeca(${peca.id})" class="p-1 text-red-600 hover:bg-red-50 rounded" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderTecnicos(container) {
            const perms = currentUser.permissions.tecnicos || [];
            
            container.innerHTML = `
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex gap-2">
                        ${perms.includes('create') ? `
                            <button onclick="openTecnicoModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Novo Técnico
                            </button>
                        ` : ''}
                    </div>
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="tecnico-search" placeholder="Buscar técnicos..." class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-64" onkeyup="filterTecnicos()">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="tecnicos-grid">
                    ${renderTecnicoCards(tecnicos)}
                </div>
            `;
        }

        function renderTecnicoCards(data) {
            const perms = currentUser.permissions.tecnicos || [];
            
            return data.map(tec => `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden card-hover">
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(tec.nome)}&background=3b82f6&color=fff" class="w-12 h-12 rounded-full">
                                <div>
                                    <h3 class="font-bold text-slate-800">${tec.nome}</h3>
                                    <p class="text-sm text-slate-500">${tec.especialidade}</p>
                                </div>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${tec.ativo ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${tec.ativo ? 'Ativo' : 'Inativo'}
                            </span>
                        </div>
                        
                        <div class="space-y-2 text-sm text-slate-600 mb-4">
                            <div class="flex items-center gap-2">
                                <i data-lucide="mail" class="w-4 h-4"></i>
                                <span>${tec.email}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="phone" class="w-4 h-4"></i>
                                <span>${tec.telefone}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="credit-card" class="w-4 h-4"></i>
                                <span>Registro: ${tec.registro}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 pt-4 border-t border-slate-100">
                            <button onclick="viewTecnico(${tec.id})" class="flex-1 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">Detalhes</button>
                            ${perms.includes('edit') ? `<button onclick="editTecnico(${tec.id})" class="p-2 text-orange-600 hover:bg-orange-50 rounded-lg"><i data-lucide="edit" class="w-4 h-4"></i></button>` : ''}
                            ${perms.includes('delete') ? `<button onclick="deleteTecnico(${tec.id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderCustos(container) {
            container.innerHTML = `
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <button onclick="openCustosModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                        <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                        Análise Detalhada por Contrato
                    </button>
                    <div class="flex gap-2">
                        <select class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option>Últimos 30 dias</option>
                            <option>Últimos 3 meses</option>
                            <option>Últimos 6 meses</option>
                            <option>Este ano</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-blue-100 rounded-lg">
                                <i data-lucide="wrench" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <span class="text-2xl font-bold text-slate-800">R$ 98.356</span>
                        </div>
                        <p class="text-sm text-slate-600">Custos com Peças</p>
                        <p class="text-xs text-blue-600 mt-1">40% do total</p>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-green-100 rounded-lg">
                                <i data-lucide="users" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <span class="text-2xl font-bold text-slate-800">R$ 73.767</span>
                        </div>
                        <p class="text-sm text-slate-600">Mão de Obra</p>
                        <p class="text-xs text-green-600 mt-1">30% do total</p>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-orange-100 rounded-lg">
                                <i data-lucide="fuel" class="w-6 h-6 text-orange-600"></i>
                            </div>
                            <span class="text-2xl font-bold text-slate-800">R$ 73.767</span>
                        </div>
                        <p class="text-sm text-slate-600">Combustível</p>
                        <p class="text-xs text-orange-600 mt-1">30% do total</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-200">
                        <h3 class="font-bold text-slate-800">Resumo por Categoria</h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium text-slate-700">Manutenção Preventiva</span>
                                    <span class="font-bold text-slate-800">R$ 125.000,00</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-3">
                                    <div class="bg-blue-500 h-3 rounded-full" style="width: 65%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium text-slate-700">Manutenção Corretiva</span>
                                    <span class="font-bold text-slate-800">R$ 85.000,00</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-3">
                                    <div class="bg-red-500 h-3 rounded-full" style="width: 35%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdmin(container) {
            const perms = currentUser.permissions.admin || [];
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-blue-100 rounded-lg">
                                <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <span class="text-2xl font-bold text-slate-800">${users.length}</span>
                        </div>
                        <p class="text-sm text-slate-600">Total de Usuários</p>
                        <p class="text-xs text-green-600 mt-1">${users.filter(u => u.ativo).length} ativos</p>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-purple-100 rounded-lg">
                                <i data-lucide="shield" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <span class="text-2xl font-bold text-slate-800">5</span>
                        </div>
                        <p class="text-sm text-slate-600">Perfis de Acesso</p>
                        <p class="text-xs text-slate-500 mt-1">31 permissões configuradas</p>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-green-100 rounded-lg">
                                <i data-lucide="activity" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <span class="text-2xl font-bold text-slate-800">${securityLogs.length}</span>
                        </div>
                        <p class="text-sm text-slate-600">Logs Registrados</p>
                        <p class="text-xs text-green-600 mt-1">100% sucesso hoje</p>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-red-100 rounded-lg">
                                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <span class="text-2xl font-bold text-slate-800">1</span>
                        </div>
                        <p class="text-sm text-slate-600">Alertas de Segurança</p>
                        <p class="text-xs text-red-600 mt-1">Tentativa de acesso negada</p>
                    </div>
                </div>

                <div class="bg-white rounded-t-xl border-b border-slate-200 flex">
                    <button onclick="switchAdminTab('usuarios')" class="admin-tab active px-6 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 hover:bg-slate-50 transition-colors" data-tab="usuarios">Usuários</button>
                    <button onclick="switchAdminTab('permissoes')" class="admin-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:bg-slate-50 transition-colors" data-tab="permissoes">Permissões</button>
                    <button onclick="switchAdminTab('logs')" class="admin-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:bg-slate-50 transition-colors" data-tab="logs">Logs de Segurança</button>
                    <button onclick="switchAdminTab('config')" class="admin-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:bg-slate-50 transition-colors" data-tab="config">Configurações</button>
                </div>

                <div class="bg-white rounded-b-xl shadow-sm border border-slate-200 p-6" id="admin-content">
                    ${renderUsuariosTab()}
                </div>
            `;
        }

        function renderUsuariosTab() {
            const perms = currentUser.permissions.admin || [];
            
            return `
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    ${perms.includes('create') ? `
                        <button onclick="openUserModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Novo Usuário
                        </button>
                    ` : '<div></div>'}
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="user-search" placeholder="Buscar usuários..." class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-64" onkeyup="filterUsers()">
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Usuário</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Perfil</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Status</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Último Acesso</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="users-table-body">
                            ${renderUsersTableRows(users)}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderUsersTableRows(data) {
            const perms = currentUser.permissions.admin || [];
            
            return data.map(user => {
                const profile = PROFILES[user.perfil];
                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.nome)}&background=3b82f6&color=fff" class="w-10 h-10 rounded-full">
                                <div>
                                    <p class="font-medium text-slate-900">${user.nome}</p>
                                    <p class="text-sm text-slate-500">${user.email}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${profile.color}">${profile.name}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${user.ativo ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${user.ativo ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">${user.ultimoAcesso || 'Nunca'}</td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                ${perms.includes('edit') ? `<button onclick="editUser(${user.id})" class="p-1 text-blue-600 hover:bg-blue-50 rounded" title="Editar"><i data-lucide="edit" class="w-4 h-4"></i></button>` : ''}
                                ${perms.includes('edit') ? `<button onclick="toggleUserStatus(${user.id})" class="p-1 ${user.ativo ? 'text-orange-600 hover:bg-orange-50' : 'text-green-600 hover:bg-green-50'} rounded" title="${user.ativo ? 'Desativar' : 'Ativar'}"><i data-lucide="${user.ativo ? 'user-x' : 'user-check'}" class="w-4 h-4"></i></button>` : ''}
                                ${perms.includes('delete') ? `<button onclick="deleteUser(${user.id})" class="p-1 text-red-600 hover:bg-red-50 rounded" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderPermissoesTab() {
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800">Gerenciamento de Permissões por Perfil</h3>
                        <select id="profile-select" onchange="renderPermissionsMatrix()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            ${Object.entries(PROFILES).map(([key, prof]) => `<option value="${key}">${prof.name}</option>`).join('')}
                        </select>
                    </div>
                    <div id="permissions-matrix" class="space-y-4">
                        ${renderPermissionsMatrix()}
                    </div>
                </div>
            `;
        }

        function renderPermissionsMatrix() {
            const profileKey = document.getElementById('profile-select')?.value || 'superadmin';
            const profile = PROFILES[profileKey];
            
            return Object.entries(PERMISSIONS).map(([module, perms]) => `
                <div class="border border-slate-200 rounded-lg overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 font-semibold text-slate-700 capitalize flex items-center gap-2">
                        <i data-lucide="${getModuleIcon(module)}" class="w-4 h-4"></i>
                        ${module}
                    </div>
                    <div class="divide-y divide-slate-100">
                        ${Object.entries(perms).map(([perm, label]) => {
                            const hasPerm = profile.permissions[module] && profile.permissions[module].includes(perm);
                            return `
                                <div class="flex items-center justify-between px-4 py-3 hover:bg-slate-50">
                                    <span class="text-sm text-slate-700">${label}</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" class="sr-only peer" ${hasPerm ? 'checked' : ''} 
                                            onchange="togglePermission('${profileKey}', '${module}', '${perm}')" 
                                            ${profileKey === 'superadmin' ? 'disabled' : ''}>
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 ${profileKey === 'superadmin' ? 'opacity-50' : ''}"></div>
                                    </label>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        function getModuleIcon(module) {
            const icons = {
                dashboard: 'layout-dashboard', os: 'clipboard-list', equipamentos: 'truck',
                horimetro: 'gauge', combustivel: 'fuel', pecas: 'package',
                tecnicos: 'users', custos: 'pie-chart', admin: 'shield'
            };
            return icons[module] || 'circle';
        }

        function renderLogsTab() {
            return `
                <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex gap-2">
                        <select id="log-filter-action" onchange="filterLogs()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            <option value="">Todas as ações</option>
                            <option value="LOGIN">Login</option>
                            <option value="LOGOUT">Logout</option>
                            <option value="CREATE">Criação</option>
                            <option value="UPDATE">Atualização</option>
                            <option value="DELETE">Exclusão</option>
                        </select>
                        <select id="log-filter-status" onchange="filterLogs()" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                            <option value="">Todos os status</option>
                            <option value="SUCESSO">Sucesso</option>
                            <option value="FALHA">Falha</option>
                        </select>
                    </div>
                    <button onclick="exportLogs()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors text-sm">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Exportar CSV
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Data/Hora</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Usuário</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Ação</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Módulo</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Status</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">IP</th>
                                <th class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-6 py-3">Detalhes</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="logs-table-body">
                            ${renderLogsTableRows(securityLogs)}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderLogsTableRows(data) {
            return data.map(log => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 text-sm text-slate-600 font-mono">${log.timestamp}</td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-900">${log.usuario}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-semibold bg-slate-100 text-slate-700">${log.acao}</span></td>
                    <td class="px-6 py-4 text-sm text-slate-600">${log.modulo}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${log.status === 'SUCESSO' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${log.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-500 font-mono">${log.ip}</td>
                    <td class="px-6 py-4 text-sm text-slate-600">${log.detalhes}</td>
                </tr>
            `).join('');
        }

        function renderConfigTab() {
            return `
                <div class="max-w-3xl space-y-6">
                    <div class="border border-slate-200 rounded-lg p-6">
                        <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="settings" class="w-5 h-5 text-blue-500"></i>
                            Configurações Gerais
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Nome da Empresa</label>
                                <input type="text" value="${systemConfig.geral.empresa}" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Idioma</label>
                                <select class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="pt-BR" selected>Português (Brasil)</option>
                                    <option value="en-US">English (US)</option>
                                    <option value="es">Español</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="border border-slate-200 rounded-lg p-6">
                        <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="shield" class="w-5 h-5 text-green-500"></i>
                            Política de Segurança
                        </h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-slate-700">Política de Senha Forte</p>
                                    <p class="text-sm text-slate-500">Exigir maiúsculas, números e símbolos</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" ${systemConfig.seguranca.politicaSenha === 'strong' ? 'checked' : ''}>
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-slate-700">Autenticação de Dois Fatores (2FA)</p>
                                    <p class="text-sm text-slate-500">Exigir código adicional no login</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" ${systemConfig.seguranca.doisFatores ? 'checked' : ''}>
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-4 pt-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Tentativas de Login</label>
                                    <input type="number" value="${systemConfig.seguranca.tentativasLogin}" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Timeout de Sessão (min)</label>
                                    <input type="number" value="${systemConfig.seguranca.sessaoTimeout}" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border border-slate-200 rounded-lg p-6">
                        <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="bell" class="w-5 h-5 text-orange-500"></i>
                            Notificações
                        </h4>
                        <div class="space-y-3">
                            ${Object.entries(systemConfig.notificacoes).map(([key, value]) => `
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" ${value ? 'checked' : ''}>
                                    <span class="text-sm text-slate-700 capitalize">${key.replace(/([A-Z])/g, ' $1').trim()}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button class="px-6 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors">Restaurar Padrões</button>
                        <button onclick="saveConfig()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            Salvar Configurações
                        </button>
                    </div>
                </div>
            `;
        }

        // ==================== MODAL FUNCTIONS ====================

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.body.style.overflow = '';
        }

        // OS Modal Functions
        function openOSModal(osId = null) {
            const modal = document.getElementById('os-modal');
            const form = document.getElementById('os-form');
            const title = document.getElementById('os-modal-title');
            const subtitle = document.getElementById('os-modal-subtitle');
            
            // Populate selects
            const equipSelect = document.getElementById('os-equipamento');
            equipSelect.innerHTML = '<option value="">Selecione o equipamento...</option>' + 
                equipamentosData.map(e => `<option value="${e.id}">${e.id} - ${e.nome}</option>`).join('');
            
            const respSelect = document.getElementById('os-responsavel');
            respSelect.innerHTML = '<option value="">Selecione o técnico...</option>' + 
                tecnicos.filter(t => t.ativo).map(t => `<option value="${t.nome}">${t.nome}</option>`).join('');
            
            if (osId) {
                const os = osData.find(o => o.id === osId);
                title.textContent = 'Editar Ordem de Serviço';
                subtitle.textContent = `OS ${osId}`;
                document.getElementById('os-id').value = os.id;
                document.getElementById('os-titulo').value = os.titulo;
                document.getElementById('os-equipamento').value = os.equipamento;
                document.getElementById('os-tipo').value = os.tipo;
                document.getElementById('os-prioridade').value = os.prioridade;
                document.getElementById('os-responsavel').value = os.responsavel;
                document.getElementById('os-data').value = os.data;
                document.getElementById('os-previsao').value = os.previsao || '';
                document.getElementById('os-status').value = os.status;
                document.getElementById('os-descricao').value = os.descricao || '';
            } else {
                title.textContent = 'Nova Ordem de Serviço';
                subtitle.textContent = 'Preencha os dados da manutenção';
                form.reset();
                document.getElementById('os-id').value = '';
                document.getElementById('os-data').value = new Date().toISOString().split('T')[0];
            }
            
            openModal('os-modal');
        }

        function saveOS(e) {
            e.preventDefault();
            const id = document.getElementById('os-id').value;
            const osData_new = {
                titulo: document.getElementById('os-titulo').value,
                equipamento: document.getElementById('os-equipamento').value,
                tipo: document.getElementById('os-tipo').value,
                prioridade: document.getElementById('os-prioridade').value,
                responsavel: document.getElementById('os-responsavel').value,
                data: document.getElementById('os-data').value,
                previsao: document.getElementById('os-previsao').value,
                status: document.getElementById('os-status').value,
                descricao: document.getElementById('os-descricao').value,
                pecas: []
            };

            if (id) {
                const index = osData.findIndex(o => o.id === id);
                osData[index] = { ...osData[index], ...osData_new };
                addSecurityLog(currentUser.email, 'UPDATE', 'OS', 'SUCESSO', `Atualizou OS ${id}`);
            } else {
                const newId = 'OS-2024-' + String(osData.length + 1).padStart(3, '0');
                osData.unshift({ id: newId, ...osData_new, conclusao: null });
                addSecurityLog(currentUser.email, 'CREATE', 'OS', 'SUCESSO', `Criou OS ${newId}`);
            }

            closeModal('os-modal');
            navigateTo('os');
        }

        function viewOS(id) {
            const os = osData.find(o => o.id === id);
            const equip = equipamentosData.find(e => e.id === os.equipamento);
            
            document.getElementById('os-view-id').textContent = os.id;
            document.getElementById('os-view-status').innerHTML = `Status: <span class="px-2 py-1 rounded-full text-xs font-semibold ${os.status === 'aberta' ? 'bg-yellow-100 text-yellow-800' : os.status === 'andamento' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${os.status.toUpperCase()}</span>`;
            document.getElementById('os-view-equipamento').textContent = equip ? equip.nome : os.equipamento;
            document.getElementById('os-view-tipo').textContent = os.tipo;
            document.getElementById('os-view-prioridade').innerHTML = `<span class="px-2 py-1 rounded-full text-xs font-semibold ${os.prioridade === 'critica' ? 'bg-red-100 text-red-800' : os.prioridade === 'alta' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}">${os.prioridade.toUpperCase()}</span>`;
            document.getElementById('os-view-responsavel').textContent = os.responsavel;
            document.getElementById('os-view-data').textContent = formatDate(os.data);
            document.getElementById('os-view-previsao').textContent = os.previsao ? formatDate(os.previsao) : '-';
            document.getElementById('os-view-conclusao').textContent = os.conclusao ? formatDate(os.conclusao) : '-';
            document.getElementById('os-view-descricao').textContent = os.descricao || 'Sem descrição detalhada.';
            
            const pecasHtml = os.pecas && os.pecas.length > 0 ? os.pecas.map(p => `
                <tr>
                    <td class="px-4 py-2">${p.nome}</td>
                    <td class="px-4 py-2 text-center">${p.qtd}</td>
                    <td class="px-4 py-2 text-right">R$ ${p.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="px-4 py-2 text-right font-medium">R$ ${(p.qtd * p.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>
            `).join('') : '<tr><td colspan="4" class="px-4 py-4 text-center text-slate-500">Nenhuma peça registrada</td></tr>';
            
            document.getElementById('os-view-pecas').innerHTML = pecasHtml;
            
            openModal('os-view-modal');
        }

        function editOS(id) {
            openOSModal(id);
        }

        function startOS(id) {
            const os = osData.find(o => o.id === id);
            os.status = 'andamento';
            addSecurityLog(currentUser.email, 'UPDATE', 'OS', 'SUCESSO', `Iniciou OS ${id}`);
            filterOSByStatus('all');
        }

        function completeOS(id) {
            const os = osData.find(o => o.id === id);
            os.status = 'finalizada';
            os.conclusao = new Date().toISOString().split('T')[0];
            addSecurityLog(currentUser.email, 'UPDATE', 'OS', 'SUCESSO', `Concluiu OS ${id}`);
            filterOSByStatus('all');
        }

        function deleteOS(id) {
            if (confirm('Deseja realmente excluir esta OS?')) {
                osData = osData.filter(o => o.id !== id);
                addSecurityLog(currentUser.email, 'DELETE', 'OS', 'SUCESSO', `Excluiu OS ${id}`);
                filterOSByStatus('all');
            }
        }

        function printOS() {
            alert('Imprimindo OS... (função de impressão)');
        }

        // Equipment Modal Functions
        function openEquipModal(equipId = null) {
            const modal = document.getElementById('equip-modal');
            const title = document.getElementById('equip-modal-title');
            
            if (equipId) {
                const equip = equipamentosData.find(e => e.id === equipId);
                title.textContent = 'Editar Equipamento';
                document.getElementById('equip-id').value = equip.id;
                document.getElementById('equip-codigo').value = equip.id;
                document.getElementById('equip-nome').value = equip.nome;
                document.getElementById('equip-tipo').value = equip.tipo;
                document.getElementById('equip-marca').value = equip.marca || '';
                document.getElementById('equip-modelo').value = equip.modelo || '';
                document.getElementById('equip-ano').value = equip.ano || '';
                document.getElementById('equip-chassi').value = equip.chassi || '';
                document.getElementById('equip-status').value = equip.status;
                document.getElementById('equip-horimetro').value = equip.horimetro;
                document.getElementById('equip-proxima-manut').value = equip.proximaManutencao;
                document.getElementById('equip-obs').value = equip.obs || '';
            } else {
                title.textContent = 'Novo Equipamento';
                document.getElementById('equip-form').reset();
                document.getElementById('equip-id').value = '';
            }
            
            openModal('equip-modal');
        }

        function saveEquip(e) {
            e.preventDefault();
            const id = document.getElementById('equip-id').value;
            const equipData = {
                id: document.getElementById('equip-codigo').value.toUpperCase(),
                nome: document.getElementById('equip-nome').value,
                tipo: document.getElementById('equip-tipo').value,
                marca: document.getElementById('equip-marca').value,
                modelo: document.getElementById('equip-modelo').value,
                ano: document.getElementById('equip-ano').value,
                chassi: document.getElementById('equip-chassi').value,
                status: document.getElementById('equip-status').value,
                horimetro: parseInt(document.getElementById('equip-horimetro').value) || 0,
                proximaManutencao: parseInt(document.getElementById('equip-proxima-manut').value) || 0,
                obs: document.getElementById('equip-obs').value,
                alerta: 'ok'
            };

            // Calculate alert status
            const percent = (equipData.horimetro / equipData.proximaManutencao * 100);
            if (percent >= 95) equipData.alerta = 'danger';
            else if (percent >= 80) equipData.alerta = 'warning';

            if (id) {
                const index = equipamentosData.findIndex(e => e.id === id);
                equipamentosData[index] = { ...equipamentosData[index], ...equipData };
                addSecurityLog(currentUser.email, 'UPDATE', 'Equipamentos', 'SUCESSO', `Atualizou equipamento ${equipData.id}`);
            } else {
                equipamentosData.push(equipData);
                addSecurityLog(currentUser.email, 'CREATE', 'Equipamentos', 'SUCESSO', `Cadastrou equipamento ${equipData.id}`);
            }

            closeModal('equip-modal');
            navigateTo('equipamentos');
        }

        function viewEquip(id) {
            alert(`Visualizando detalhes do equipamento ${id}\n\nEm uma implementação completa, abriria um modal com todas as informações, histórico de manutenções, documentos, etc.`);
        }

        function changeEquipStatus(id, status) {
            if (!status) return;
            const eq = equipamentosData.find(e => e.id === id);
            eq.status = status;
            addSecurityLog(currentUser.email, 'UPDATE', 'Equipamentos', 'SUCESSO', `Alterou status de ${id} para ${status}`);
            navigateTo('equipamentos');
        }

        // Horimetro Modal Functions
        function openHorimetroModal() {
            const select = document.getElementById('horimetro-equipamento');
            select.innerHTML = '<option value="">Selecione...</option>' + 
                equipamentosData.map(e => `<option value="${e.id}">${e.id} - ${e.nome}</option>`).join('');
            
            document.getElementById('horimetro-form').reset();
            document.getElementById('horimetro-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('horimetro-anterior').textContent = '0h';
            
            openModal('horimetro-modal');
        }

        function updateHorimetroAtual() {
            const equipId = document.getElementById('horimetro-equipamento').value;
            if (equipId) {
                const equip = equipamentosData.find(e => e.id === equipId);
                document.getElementById('horimetro-anterior').textContent = equip.horimetro + 'h';
            }
        }

        function saveHorimetro(e) {
            e.preventDefault();
            const equipId = document.getElementById('horimetro-equipamento').value;
            const novaLeitura = parseInt(document.getElementById('horimetro-leitura').value);
            const equip = equipamentosData.find(e => e.id === equipId);
            
            if (novaLeitura <= equip.horimetro) {
                alert('A nova leitura deve ser maior que a leitura anterior!');
                return;
            }

            const registro = {
                id: horimetroData.length + 1,
                equipamento: equipId,
                leitura: novaLeitura,
                data: document.getElementById('horimetro-data').value,
                operador: document.getElementById('horimetro-operador').value || currentUser.nome,
                diferenca: novaLeitura - equip.horimetro,
                obs: document.getElementById('horimetro-obs').value
            };

            horimetroData.unshift(registro);
            equip.horimetro = novaLeitura;
            
            // Update alert status
            const percent = (equip.horimetro / equip.proximaManutencao * 100);
            if (percent >= 95) equip.alerta = 'danger';
            else if (percent >= 80) equip.alerta = 'warning';
            else equip.alerta = 'ok';

            addSecurityLog(currentUser.email, 'CREATE', 'Horimetro', 'SUCESSO', `Registrou horímetro ${novaLeitura}h para ${equipId}`);
            
            closeModal('horimetro-modal');
            navigateTo('horimetro');
        }

        function viewHorimetroHistory(equipId) {
            const equip = equipamentosData.find(e => e.id === equipId);
            const historico = horimetroData.filter(h => h.equipamento === equipId);
            
            document.getElementById('hist-equip-nome').textContent = `${equip.id} - ${equip.nome}`;
            document.getElementById('hist-horimetro-atual').textContent = equip.horimetro.toLocaleString('pt-BR') + 'h';
            document.getElementById('hist-total-registros').textContent = historico.length;
            
            const timelineHtml = historico.map((h, idx) => `
                <div class="timeline-item">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-slate-800">${h.leitura.toLocaleString('pt-BR')}h</span>
                        <span class="text-sm text-slate-500">${formatDate(h.data)}</span>
                    </div>
                    <p class="text-sm text-slate-600">Operador: ${h.operador}</p>
                    ${h.diferenca > 0 ? `<p class="text-xs text-green-600 mt-1">+${h.diferenca}h desde o último registro</p>` : ''}
                    ${h.obs ? `<p class="text-xs text-slate-500 mt-1">${h.obs}</p>` : ''}
                </div>
            `).join('');
            
            document.getElementById('hist-timeline').innerHTML = timelineHtml || '<p class="text-slate-500 text-center py-8">Nenhum histórico encontrado</p>';
            
            openModal('horimetro-history-modal');
        }

        function exportHorimetroHistory() {
            alert('Exportando histórico para Excel...');
        }

        // Combustivel Modal Functions
        function openCombustivelModal(combId = null) {
            const select = document.getElementById('combustivel-equipamento');
            select.innerHTML = '<option value="">Selecione...</option>' + 
                equipamentosData.map(e => `<option value="${e.id}">${e.id} - ${e.nome}</option>`).join('');
            
            if (combId) {
                const comb = combustivelData.find(c => c.id === combId);
                document.getElementById('combustivel-id').value = comb.id;
                document.getElementById('combustivel-equipamento').value = comb.equipamento;
                document.getElementById('combustivel-data').value = comb.data;
                document.getElementById('combustivel-km').value = comb.km;
                document.getElementById('combustivel-tipo').value = comb.tipo;
                document.getElementById('combustivel-quantidade').value = comb.quantidade;
                document.getElementById('combustivel-valor-unit').value = comb.valorUnit;
                document.getElementById('combustivel-valor-total').value = comb.valorTotal;
                document.getElementById('combustivel-fornecedor').value = comb.fornecedor || '';
                document.getElementById('combustivel-nf').value = comb.nf || '';
                document.getElementById('combustivel-modal-title').textContent = 'Editar Abastecimento';
            } else {
                document.getElementById('combustivel-form').reset();
                document.getElementById('combustivel-id').value = '';
                document.getElementById('combustivel-data').value = new Date().toISOString().split('T')[0];
                document.getElementById('combustivel-modal-title').textContent = 'Registrar Abastecimento';
            }
            
            openModal('combustivel-modal');
        }

        function calcularTotalCombustivel() {
            const qtd = parseFloat(document.getElementById('combustivel-quantidade').value) || 0;
            const unit = parseFloat(document.getElementById('combustivel-valor-unit').value) || 0;
            document.getElementById('combustivel-valor-total').value = (qtd * unit).toFixed(2);
        }

        function saveCombustivel(e) {
            e.preventDefault();
            const id = document.getElementById('combustivel-id').value;
            const combData = {
                equipamento: document.getElementById('combustivel-equipamento').value,
                data: document.getElementById('combustivel-data').value,
                km: parseInt(document.getElementById('combustivel-km').value),
                tipo: document.getElementById('combustivel-tipo').value,
                quantidade: parseFloat(document.getElementById('combustivel-quantidade').value),
                valorUnit: parseFloat(document.getElementById('combustivel-valor-unit').value) || 0,
                valorTotal: parseFloat(document.getElementById('combustivel-valor-total').value) || 0,
                fornecedor: document.getElementById('combustivel-fornecedor').value,
                nf: document.getElementById('combustivel-nf').value
            };

            if (id) {
                const index = combustivelData.findIndex(c => c.id == id);
                combustivelData[index] = { ...combustivelData[index], ...combData };
                addSecurityLog(currentUser.email, 'UPDATE', 'Combustivel', 'SUCESSO', `Atualizou abastecimento ${id}`);
            } else {
                const newId = Math.max(...combustivelData.map(c => c.id)) + 1;
                combustivelData.unshift({ id: newId, ...combData });
                addSecurityLog(currentUser.email, 'CREATE', 'Combustivel', 'SUCESSO', `Registrou abastecimento ${newId}`);
            }

            closeModal('combustivel-modal');
            navigateTo('combustivel');
        }

        function editCombustivel(id) {
            openCombustivelModal(id);
        }

        function deleteCombustivel(id) {
            if (confirm('Deseja excluir este registro de abastecimento?')) {
                combustivelData = combustivelData.filter(c => c.id !== id);
                addSecurityLog(currentUser.email, 'DELETE', 'Combustivel', 'SUCESSO', `Excluiu abastecimento ${id}`);
                navigateTo('combustivel');
            }
        }

        // Tecnico Modal Functions
        function openTecnicoModal(tecId = null) {
            if (tecId) {
                const tec = tecnicos.find(t => t.id === tecId);
                document.getElementById('tecnico-id').value = tec.id;
                document.getElementById('tecnico-nome').value = tec.nome;
                document.getElementById('tecnico-email').value = tec.email;
                document.getElementById('tecnico-telefone').value = tec.telefone;
                document.getElementById('tecnico-cpf').value = tec.cpf;
                document.getElementById('tecnico-especialidade').value = tec.especialidade;
                document.getElementById('tecnico-registro').value = tec.registro;
                document.getElementById('tecnico-endereco').value = tec.endereco || '';
                document.getElementById('tecnico-obs').value = tec.obs || '';
                document.getElementById('tecnico-ativo').checked = tec.ativo;
                document.getElementById('tecnico-modal-title').textContent = 'Editar Técnico';
            } else {
                document.getElementById('tecnico-form').reset();
                document.getElementById('tecnico-id').value = '';
                document.getElementById('tecnico-ativo').checked = true;
                document.getElementById('tecnico-modal-title').textContent = 'Novo Técnico';
            }
            
            openModal('tecnico-modal');
        }

        function saveTecnico(e) {
            e.preventDefault();
            const id = document.getElementById('tecnico-id').value;
            const tecData = {
                nome: document.getElementById('tecnico-nome').value,
                email: document.getElementById('tecnico-email').value,
                telefone: document.getElementById('tecnico-telefone').value,
                cpf: document.getElementById('tecnico-cpf').value,
                especialidade: document.getElementById('tecnico-especialidade').value,
                registro: document.getElementById('tecnico-registro').value,
                endereco: document.getElementById('tecnico-endereco').value,
                obs: document.getElementById('tecnico-obs').value,
                ativo: document.getElementById('tecnico-ativo').checked
            };

            if (id) {
                const index = tecnicos.findIndex(t => t.id == id);
                tecnicos[index] = { ...tecnicos[index], ...tecData };
                addSecurityLog(currentUser.email, 'UPDATE', 'Tecnicos', 'SUCESSO', `Atualizou técnico ${tecData.nome}`);
            } else {
                const newId = Math.max(...tecnicos.map(t => t.id)) + 1;
                tecnicos.push({ id: newId, ...tecData });
                addSecurityLog(currentUser.email, 'CREATE', 'Tecnicos', 'SUCESSO', `Cadastrou técnico ${tecData.nome}`);
            }

            closeModal('tecnico-modal');
            navigateTo('tecnicos');
        }

        function viewTecnico(id) {
            const tec = tecnicos.find(t => t.id === id);
            alert(`Detalhes do Técnico:\n\nNome: ${tec.nome}\nEmail: ${tec.email}\nTelefone: ${tec.telefone}\nEspecialidade: ${tec.especialidade}\nRegistro: ${tec.registro}\n\nEm uma implementação completa, abriria um modal com todas as informações, histórico de OS, etc.`);
        }

        function editTecnico(id) {
            openTecnicoModal(id);
        }

        function deleteTecnico(id) {
            if (confirm('Deseja excluir este técnico?')) {
                tecnicos = tecnicos.filter(t => t.id !== id);
                addSecurityLog(currentUser.email, 'DELETE', 'Tecnicos', 'SUCESSO', `Excluiu técnico ID ${id}`);
                navigateTo('tecnicos');
            }
        }

        function filterTecnicos() {
            const search = document.getElementById('tecnico-search').value.toLowerCase();
            const filtered = tecnicos.filter(t => 
                t.nome.toLowerCase().includes(search) || 
                t.email.toLowerCase().includes(search) ||
                t.especialidade.toLowerCase().includes(search)
            );
            document.getElementById('tecnicos-grid').innerHTML = renderTecnicoCards(filtered);
            lucide.createIcons();
        }

        // Peça Modal Functions
        function openPecaModal(pecaId = null) {
            if (pecaId) {
                const peca = pecas.find(p => p.id === pecaId);
                document.getElementById('peca-id').value = peca.id;
                document.getElementById('peca-codigo').value = peca.codigo;
                document.getElementById('peca-nome').value = peca.nome;
                document.getElementById('peca-categoria').value = peca.categoria;
                document.getElementById('peca-fornecedor').value = peca.fornecedor || '';
                document.getElementById('peca-quantidade').value = peca.quantidade;
                document.getElementById('peca-minimo').value = peca.minimo;
                document.getElementById('peca-unidade').value = peca.unidade;
                document.getElementById('peca-custo').value = peca.custo;
                document.getElementById('peca-venda').value = peca.venda;
                document.getElementById('peca-localizacao').value = peca.localizacao || '';
                document.getElementById('peca-descricao').value = peca.descricao || '';
                document.getElementById('peca-modal-title').textContent = 'Editar Peça';
            } else {
                document.getElementById('peca-form').reset();
                document.getElementById('peca-id').value = '';
                document.getElementById('peca-modal-title').textContent = 'Nova Peça';
            }
            
            openModal('peca-modal');
        }

        function savePeca(e) {
            e.preventDefault();
            const id = document.getElementById('peca-id').value;
            const pecaData = {
                codigo: document.getElementById('peca-codigo').value.toUpperCase(),
                nome: document.getElementById('peca-nome').value,
                categoria: document.getElementById('peca-categoria').value,
                fornecedor: document.getElementById('peca-fornecedor').value,
                quantidade: parseInt(document.getElementById('peca-quantidade').value) || 0,
                minimo: parseInt(document.getElementById('peca-minimo').value) || 5,
                unidade: document.getElementById('peca-unidade').value,
                custo: parseFloat(document.getElementById('peca-custo').value) || 0,
                venda: parseFloat(document.getElementById('peca-venda').value) || 0,
                localizacao: document.getElementById('peca-localizacao').value,
                descricao: document.getElementById('peca-descricao').value
            };

            if (id) {
                const index = pecas.findIndex(p => p.id == id);
                pecas[index] = { ...pecas[index], ...pecaData };
                addSecurityLog(currentUser.email, 'UPDATE', 'Pecas', 'SUCESSO', `Atualizou peça ${pecaData.codigo}`);
            } else {
                const newId = Math.max(...pecas.map(p => p.id)) + 1;
                pecas.push({ id: newId, ...pecaData });
                addSecurityLog(currentUser.email, 'CREATE', 'Pecas', 'SUCESSO', `Cadastrou peça ${pecaData.codigo}`);
            }

            closeModal('peca-modal');
            navigateTo('pecas');
        }

        function viewPeca(id) {
            const peca = pecas.find(p => p.id === id);
            alert(`Detalhes da Peça:\n\nCódigo: ${peca.codigo}\nNome: ${peca.nome}\nCategoria: ${peca.categoria}\nEstoque: ${peca.quantidade} ${peca.unidade}\nPreço Venda: R$ ${peca.venda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\nLocalização: ${peca.localizacao}\n\nEm uma implementação completa, abriria um modal com todas as informações, movimentações, etc.`);
        }

        function editPeca(id) {
            openPecaModal(id);
        }

        function deletePeca(id) {
            if (confirm('Deseja excluir esta peça?')) {
                pecas = pecas.filter(p => p.id !== id);
                addSecurityLog(currentUser.email, 'DELETE', 'Pecas', 'SUCESSO', `Excluiu peça ID ${id}`);
                navigateTo('pecas');
            }
        }

        function filterPecas() {
            const search = document.getElementById('peca-search').value.toLowerCase();
            const filtered = pecas.filter(p => 
                p.nome.toLowerCase().includes(search) || 
                p.codigo.toLowerCase().includes(search) ||
                p.categoria.toLowerCase().includes(search)
            );
            document.getElementById('pecas-table-body').innerHTML = renderPecasTableRows(filtered);
            lucide.createIcons();
        }

        // Custos Modal Functions
        function openCustosModal() {
            const tbody = document.getElementById('custos-contratos-list');
            const totalGeral = custosContratos.reduce((acc, c) => acc + c.total, 0);
            
            tbody.innerHTML = custosContratos.map(c => {
                const percent = ((c.total / totalGeral) * 100).toFixed(1);
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3 font-medium text-slate-800">${c.contrato}</td>
                        <td class="px-4 py-3 text-right text-slate-600">R$ ${c.pecas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="px-4 py-3 text-right text-slate-600">R$ ${c.maoObra.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="px-4 py-3 text-right text-slate-600">R$ ${c.combustivel.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="px-4 py-3 text-right text-slate-600">R$ ${c.outros.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">R$ ${c.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <div class="w-16 bg-slate-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${percent}%"></div>
                                </div>
                                <span class="text-xs text-slate-600">${percent}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            openModal('custos-modal');
        }

        function exportCustos() {
            alert('Exportando análise de custos para Excel...');
        }

        // Admin Functions
        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => {
                if (t.dataset.tab === tab) {
                    t.classList.add('active', 'border-blue-500', 'text-blue-600');
                    t.classList.remove('border-transparent', 'text-slate-600');
                } else {
                    t.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    t.classList.add('border-transparent', 'text-slate-600');
                }
            });

            const content = document.getElementById('admin-content');
            switch(tab) {
                case 'usuarios':
                    content.innerHTML = renderUsuariosTab();
                    break;
                case 'permissoes':
                    content.innerHTML = renderPermissoesTab();
                    break;
                case 'logs':
                    content.innerHTML = renderLogsTab();
                    break;
                case 'config':
                    content.innerHTML = renderConfigTab();
                    break;
            }
            lucide.createIcons();
        }

        function openUserModal(userId = null) {
            const modal = document.getElementById('user-modal');
            const form = document.getElementById('user-form');
            const title = document.getElementById('user-modal-title');
            
            if (userId) {
                const user = users.find(u => u.id === userId);
                title.textContent = 'Editar Usuário';
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-nome').value = user.nome;
                document.getElementById('user-email').value = user.email;
                document.getElementById('user-perfil').value = user.perfil;
                document.getElementById('user-telefone').value = user.telefone || '';
                document.getElementById('user-ativo').checked = user.ativo;
                document.getElementById('user-senha').required = false;
            } else {
                title.textContent = 'Novo Usuário';
                form.reset();
                document.getElementById('user-id').value = '';
                document.getElementById('user-senha').required = true;
            }
            
            openModal('user-modal');
        }

        function saveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const userData = {
                nome: document.getElementById('user-nome').value,
                email: document.getElementById('user-email').value,
                perfil: document.getElementById('user-perfil').value,
                telefone: document.getElementById('user-telefone').value,
                ativo: document.getElementById('user-ativo').checked,
                createdAt: new Date().toISOString().split('T')[0]
            };

            if (id) {
                const index = users.findIndex(u => u.id == id);
                users[index] = { ...users[index], ...userData };
                addSecurityLog(currentUser.email, 'UPDATE', 'Usuários', 'SUCESSO', `Atualizou usuário ${userData.email}`);
            } else {
                const newId = Math.max(...users.map(u => u.id)) + 1;
                users.push({ id: newId, ...userData, ultimoAcesso: null });
                addSecurityLog(currentUser.email, 'CREATE', 'Usuários', 'SUCESSO', `Criou usuário ${userData.email}`);
            }

            closeModal('user-modal');
            switchAdminTab('usuarios');
        }

        function editUser(id) {
            openUserModal(id);
        }

        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            user.ativo = !user.ativo;
            addSecurityLog(currentUser.email, 'UPDATE', 'Usuários', 'SUCESSO', `${user.ativo ? 'Ativou' : 'Desativou'} usuário ${user.email}`);
            switchAdminTab('usuarios');
        }

        function deleteUser(id) {
            if (confirm('Tem certeza que deseja excluir este usuário?')) {
                const user = users.find(u => u.id === id);
                users = users.filter(u => u.id !== id);
                addSecurityLog(currentUser.email, 'DELETE', 'Usuários', 'SUCESSO', `Excluiu usuário ${user.email}`);
                switchAdminTab('usuarios');
            }
        }

        function filterUsers() {
            const search = document.getElementById('user-search').value.toLowerCase();
            const filtered = users.filter(u => 
                u.nome.toLowerCase().includes(search) || 
                u.email.toLowerCase().includes(search)
            );
            document.getElementById('users-table-body').innerHTML = renderUsersTableRows(filtered);
            lucide.createIcons();
        }

        function togglePermission(profile, module, permission) {
            const prof = PROFILES[profile];
            if (!prof.permissions[module]) prof.permissions[module] = [];
            
            const idx = prof.permissions[module].indexOf(permission);
            if (idx > -1) {
                prof.permissions[module].splice(idx, 1);
            } else {
                prof.permissions[module].push(permission);
            }
            
            addSecurityLog(currentUser.email, 'UPDATE', 'Permissões', 'SUCESSO', `Alterou permissão ${module}.${permission} para ${profile}`);
        }

        function filterLogs() {
            const action = document.getElementById('log-filter-action').value;
            const status = document.getElementById('log-filter-status').value;
            
            let filtered = securityLogs;
            if (action) filtered = filtered.filter(l => l.acao === action);
            if (status) filtered = filtered.filter(l => l.status === status);
            
            document.getElementById('logs-table-body').innerHTML = renderLogsTableRows(filtered);
            lucide.createIcons();
        }

        function exportLogs() {
            const csv = [
                ['Data/Hora', 'Usuário', 'Ação', 'Módulo', 'Status', 'IP', 'Detalhes'].join(','),
                ...securityLogs.map(l => [l.timestamp, l.usuario, l.acao, l.modulo, l.status, l.ip, `"${l.detalhes}"`].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs-seguranca-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            addSecurityLog(currentUser.email, 'EXPORT', 'Logs', 'SUCESSO', 'Exportou logs de segurança');
        }

        function saveConfig() {
            addSecurityLog(currentUser.email, 'UPDATE', 'Configurações', 'SUCESSO', 'Atualizou configurações do sistema');
            alert('Configurações salvas com sucesso!');
        }

        // Helper Functions
        function addSecurityLog(usuario, acao, modulo, status, detalhes) {
            const log = {
                id: securityLogs.length + 1,
                usuario: usuario,
                acao: acao,
                modulo: modulo,
                status: status,
                ip: '192.168.1.' + Math.floor(Math.random() * 255),
                timestamp: new Date().toLocaleString('pt-BR'),
                detalhes: detalhes
            };
            securityLogs.unshift(log);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        function filterOS() {
            const search = document.getElementById('os-search').value.toLowerCase();
            const filtered = osData.filter(os => 
                os.id.toLowerCase().includes(search) || 
                os.titulo.toLowerCase().includes(search) ||
                os.equipamento.toLowerCase().includes(search)
            );
            document.getElementById('os-table-body').innerHTML = renderOSTableRows(filtered);
            lucide.createIcons();
        }

        function filterOSByStatus(status) {
            document.querySelectorAll('.os-tab').forEach(t => {
                if (t.dataset.status === status) {
                    t.classList.add('active', 'border-blue-500', 'text-blue-600');
                    t.classList.remove('border-transparent', 'text-slate-600');
                } else {
                    t.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    t.classList.add('border-transparent', 'text-slate-600');
                }
            });

            let filtered = osData;
            if (status !== 'all') filtered = filtered.filter(os => os.status === status);
            document.getElementById('os-table-body').innerHTML = renderOSTableRows(filtered);
            lucide.createIcons();
        }

        function exportOS() {
            alert('Exportando OS para Excel...');
        }

        function filterEquip() {
            const status = document.getElementById('eq-status-filter').value;
            let filtered = equipamentosData;
            if (status) filtered = filtered.filter(e => e.status === status);
            document.getElementById('equip-grid').innerHTML = renderEquipCards(filtered);
            lucide.createIcons();
        }

        // WhatsApp Functions
        function toggleWhatsAppModal() {
            const modal = document.getElementById('whatsapp-modal');
            if (modal.classList.contains('hidden')) {
                renderWhatsAppConversations();
                modal.classList.remove('hidden');
                lucide.createIcons();
            } else {
                modal.classList.add('hidden');
            }
        }

        function renderWhatsAppConversations() {
            const container = document.getElementById('whatsapp-conversations');
            container.innerHTML = whatsappConversations.map(conv => `
                <div class="p-3 hover:bg-white cursor-pointer border-b border-slate-100 transition-colors ${conv.naoLidas > 0 ? 'bg-green-50' : ''}">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <div class="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center">
                                <i data-lucide="user" class="w-6 h-6 text-slate-400"></i>
                            </div>
                            ${conv.online ? '<span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h4 class="font-semibold text-sm text-slate-800 truncate">${conv.nome}</h4>
                                <span class="text-xs text-slate-400">${conv.hora}</span>
                            </div>
                            <p class="text-sm text-slate-600 truncate">${conv.mensagem}</p>
                        </div>
                        ${conv.naoLidas > 0 ? `<span class="bg-green-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">${conv.naoLidas}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
        });

        // Close modals on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                    if (!modal.classList.contains('hidden') && modal.id !== 'login-screen' && modal.id !== 'main-app') {
                        closeModal(modal.id);
                    }
                });
            }
        });
    </script>
</body>
</html>
